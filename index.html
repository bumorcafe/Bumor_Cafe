<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bumor Caf√©">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQnVtb3IgQ2Fmw6kiLCJzaG9ydF9uYW1lIjoiQnVtb3IiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzZCNDQyMyIsInRoZW1lX2NvbG9yIjoiIzZCNDQyMyIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnJTIweG1sbnMlM0QlMjdodHRwJTNBJTJGJTJGd3d3LnczLm9yZyUyRjIwMDAlMkZzdmclMjclM0UlM0NjaXJjbGUlMjBjeCV6M0QlMjc1MCUyNyUyMGN5JTNEJTI3NTAlMjclMjByJTNEJTI3NTAlMjclMjBmaWxsJTNEJTI3JTIzNkI0NDIzJTI3JTJGJTNFJTNDdGV4dCUyMHglM0QlMjc1MCUyNyUyMHklM0QlMjc2MCUyNyUyMGZvbnQtc2l6ZSUzRCUyNzQwJTI3JTIwZmlsbCUzRCUyN3doaXRlJTI3JTIwdGV4dC1hbmNob3IlM0QlMjdtaWRkbGUlMjclM0UlRjAlOUYlOEQlQjYlM0MlMkZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <title>Bumor Caf√© - Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #6B4423 0%, #3E2723 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .save-indicator {
            position: fixed;
            top: 70px;
            right: 16px;
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 700;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .save-indicator.saving {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: #92400E;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .save-indicator.saved {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #065F46;
        }
        .save-indicator.error {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: #991B1B;
        }
        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid #92400E;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============================================
        // CONFIGURACI√ìN - URL VERIFICADA Y CORRECTA
        // ============================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWdh3uUA1XFre4dw2qi_5jfg_5eWPRFf1sTFwD1SYPoWM1WgMTA8paI5CWi8GhLCf_8A/exec';
        // ‚úÖ URL verificada - funciona correctamente en GET
        // ============================================

        const PRODUCTOS = [
            { id: 1, nombre: 'Panela', precio: 10000, unidad: 'kg' },
            { id: 2, nombre: 'Caf√© Castillo', precio: 28000, unidad: 'lb' },
            { id: 3, nombre: 'Caf√© Bourbon Rosado', precio: 35000, unidad: 'lb' },
            { id: 4, nombre: 'Caf√© Tabi', precio: 40000, unidad: 'lb' }
        ];

        const VENDEDORES = ['Lesstherd', 'Anderson'];

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [inventario, setInventario] = useState({});
            const [inventarioAnderson, setInventarioAnderson] = useState({});
            const [ventas, setVentas] = useState([]);
            const [gastos, setGastos] = useState([]);
            const [cuentasPorCobrar, setCuentasPorCobrar] = useState([]);
            const [entregas, setEntregas] = useState([]);
            const [cuentasBanco, setCuentasBanco] = useState({
                bancolombia: 2448866,
                nuBank: 1467391,
                nequi: 867271,
                daviplata: 0,
                efectivo: 628137
            }); // Valores iniciales basados en tu captura
            
            // Estados para costos de productos y empaques
            const [costosProductos, setCostosProductos] = useState({
                panela: { costo: 0, ultimaCompra: null },
                castillo: { costo: 0, ultimaCompra: null },
                bourbon: { costo: 0, ultimaCompra: null },
                tabi: { costo: 0, ultimaCompra: null }
            });
            
            const [inventarioEmpaques, setInventarioEmpaques] = useState({
                etiquetas: { cantidad: 600, costoUnitario: 210 }, // Stickers pasan a ser etiquetas
                bolsaCastillo: { cantidad: 0, costoUnitario: 1205.26 },
                bolsaBourbon: { cantidad: 0, costoUnitario: 1205.26 },
                bolsaPanela: { cantidad: 0, costoUnitario: 609.29 },
                bolsaTabi: { cantidad: 0, costoUnitario: 1100 }
            });
            const [loading, setLoading] = useState(true);
            const [saveStatus, setSaveStatus] = useState(''); // '', 'saving', 'saved', 'error'
            const saveTimeoutRef = useRef(null);
            const savingInProgressRef = useRef(false);
            const datosInicializadosRef = useRef(false);
            const guardadoPendienteRef = useRef(false); // ‚Üê NUEVO: Flag para encolar guardado

            // Cargar datos al iniciar
            useEffect(() => {
                cargarDatos();
            }, []);

            // Guardar autom√°ticamente cuando cambien los datos
            useEffect(() => {
                // üõ°Ô∏è PROTECCI√ìN: Solo auto-guardar si los datos se cargaron correctamente
                if (!loading && datosInicializadosRef.current) {
                    // Cancelar guardado anterior si existe
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }

                    // ‚ö° OPTIMIZADO: Esperar 2 segundos antes de guardar (agrupa cambios)
                    setSaveStatus('saving');
                    saveTimeoutRef.current = setTimeout(() => {
                        guardarDatos();
                    }, 2000);
                }

                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, [inventario, inventarioAnderson, ventas, gastos, cuentasPorCobrar, entregas, cuentasBanco, costosProductos, inventarioEmpaques]);

            const cargarDatos = async () => {
                try {
                    console.log('üîÑ Cargando datos desde servidor...');
                    console.log('üì° URL:', SCRIPT_URL);
                    
                    // Agregar timestamp para evitar cach√©
                    const url = SCRIPT_URL + '?t=' + new Date().getTime();
                    
                    const res = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        // Timeout de 8 segundos
                        signal: AbortSignal.timeout(8000)
                    });

                    console.log('üì• Respuesta recibida, status:', res.status);

                    if (!res.ok) {
                        throw new Error(`Error del servidor: ${res.status} ${res.statusText}`);
                    }

                    const responseText = await res.text();
                    console.log('üìÑ Respuesta raw:', responseText.substring(0, 200));
                    
                    const json = JSON.parse(responseText);
                    console.log('‚úÖ JSON parseado:', json);

                    // Verificar si la respuesta es exitosa
                    if (json.success === false) {
                        throw new Error(json.error || 'Error desconocido del servidor');
                    }

                    // Los datos pueden venir en json.data o directamente en json
                    const remoto = json.data || json;

                    if (remoto) {
                        setInventario(remoto.inventario || {});
                        setInventarioAnderson(remoto.inventarioAnderson || {});
                        setVentas(remoto.ventas || []);
                        setGastos(remoto.gastos || []);
                        setCuentasPorCobrar(remoto.cuentasPorCobrar || []);
                        setEntregas(remoto.entregas || []);
                        setCuentasBanco(remoto.cuentasBanco || {
                            bancolombia: 2448866,
                            nuBank: 1467391,
                            nequi: 867271,
                            daviplata: 0,
                            efectivo: 628137
                        });
                        setCostosProductos(remoto.costosProductos || {
                            panela: { costo: 0, ultimaCompra: null },
                            castillo: { costo: 0, ultimaCompra: null },
                            bourbon: { costo: 0, ultimaCompra: null },
                            tabi: { costo: 0, ultimaCompra: null }
                        });
                        setInventarioEmpaques(remoto.inventarioEmpaques || {
                            etiquetas: { cantidad: 600, costoUnitario: 210 },
                            bolsaCastillo: { cantidad: 0, costoUnitario: 1205.26 },
                            bolsaBourbon: { cantidad: 0, costoUnitario: 1205.26 },
                            bolsaPanela: { cantidad: 0, costoUnitario: 609.29 },
                            bolsaTabi: { cantidad: 0, costoUnitario: 1100 }
                        });
                        console.log('üì¶ InventarioEmpaques cargado:', remoto.inventarioEmpaques);
                        console.log('‚úÖ Datos cargados exitosamente desde servidor');
                        
                        // üõ°Ô∏è PROTECCI√ìN: Marcar que los datos fueron cargados correctamente
                        datosInicializadosRef.current = true;
                    }
                } catch (e) {
                    console.error('‚ùå Error cargando desde servidor:', e);
                    console.error('Detalles del error:', e.message);
                    
                    let mensaje = 'No se pudo conectar con el servidor.\n\n';
                    
                    if (e.name === 'AbortError' || e.name === 'TimeoutError') {
                        mensaje += 'El servidor tard√≥ demasiado en responder.\n';
                    } else if (e.message.includes('Failed to fetch')) {
                        mensaje += 'Error de red. Verifica tu conexi√≥n a internet.\n';
                    } else {
                        mensaje += 'Error: ' + e.message + '\n';
                    }
                    
                    mensaje += '\n‚úÖ Pasos para solucionar:\n';
                    mensaje += '1. Verifica que la URL del script sea correcta\n';
                    mensaje += '2. Aseg√∫rate de haber desplegado el script correctamente\n';
                    mensaje += '3. Verifica que el script tenga acceso "Cualquier persona"\n';
                    mensaje += '4. Abre la consola del navegador (F12) para m√°s detalles';
                    
                    alert(mensaje);
                    
                    // üõ°Ô∏è PROTECCI√ìN CR√çTICA: NO desbloquear app si hay error de carga
                    // Esto evita que se guarden datos vac√≠os
                    console.error('üö® ERROR CR√çTICO: No se pudo cargar datos. App bloqueada para evitar p√©rdida de datos.');
                    alert('‚ö†Ô∏è ERROR CR√çTICO\n\nLa app no pudo cargar los datos del servidor.\nNO USES LA APP hasta resolver el problema.\n\nRecarga la p√°gina (F5) para intentar nuevamente.');
                    // NO hacer setLoading(false) - mantener app bloqueada
                } finally {
                    // Solo desbloquear si los datos se cargaron correctamente
                    if (datosInicializadosRef.current) {
                        setLoading(false);
                    }
                }
            };

            const guardarDatos = async (intentos = 0) => {
                // ‚úÖ PROTECCI√ìN: Si ya hay un guardado en progreso, marcar como pendiente y esperar
                if (savingInProgressRef.current) {
                    console.log('‚è≥ Guardado en progreso, encolando nuevo guardado...');
                    guardadoPendienteRef.current = true; // Marcar que hay cambios pendientes
                    return;
                }
                
                // üõ°Ô∏è PROTECCI√ìN CR√çTICA: NO guardar si los datos no fueron inicializados
                if (!datosInicializadosRef.current) {
                    console.error('üö® BLOQUEADO: Intento de guardar sin datos inicializados');
                    return;
                }
                
                // üõ°Ô∏è PROTECCI√ìN ADICIONAL: Validar que haya datos reales (no todos vac√≠os)
                const hayDatosReales = 
                    ventas.length > 0 || 
                    gastos.length > 0 || 
                    Object.keys(inventario).length > 0 ||
                    Object.keys(inventarioAnderson).length > 0 ||
                    cuentasPorCobrar.length > 0;
                
                if (!hayDatosReales) {
                    console.warn('‚ö†Ô∏è Advertencia: Intento de guardar datos completamente vac√≠os. Bloqueado por seguridad.');
                    console.warn('Si esto es intencional (primera vez), recarga la p√°gina despu√©s de configurar.');
                    return;
                }
                
                // Marcar que estamos guardando
                savingInProgressRef.current = true;
                guardadoPendienteRef.current = false; // Limpiar flag de pendiente
                
                const data = { 
                    inventario, 
                    inventarioAnderson, 
                    ventas, 
                    gastos, 
                    cuentasPorCobrar, 
                    entregas,
                    cuentasBanco,
                    costosProductos,
                    inventarioEmpaques
                };
                
                console.log('üíæ Guardando inventarioEmpaques:', inventarioEmpaques);

                try {
                    console.log('üíæ Guardando datos en servidor... (intento ' + (intentos + 1) + ')');
                    console.log('üì¶ Ventas a guardar:', ventas.length);
                    console.log('üì¶ Datos a enviar:', JSON.stringify(data).substring(0, 200));
                    
                    // Usar redirect follow para mejor compatibilidad CORS
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(data)
                    });

                    console.log('üì• Respuesta del guardado, status:', res.status);
                    
                    // Si llegamos aqu√≠ sin error, el guardado funcion√≥
                    if (res.status === 200 || res.status === 0 || res.type === 'opaque') {
                        console.log('‚úÖ Guardado exitoso (status ' + res.status + ')');
                        setSaveStatus('saved');
                        setTimeout(() => setSaveStatus(''), 2000);
                        savingInProgressRef.current = false; // ‚Üê Liberar bloqueo
                        
                        // ‚úÖ Si hab√≠a guardado pendiente, dispararlo ahora
                        if (guardadoPendienteRef.current) {
                            console.log('üîÑ Ejecutando guardado pendiente...');
                            setTimeout(() => guardarDatos(), 500); // Peque√±a pausa antes del siguiente
                        }
                        return;
                    }
                    
                    // Intentar leer la respuesta
                    try {
                        const responseText = await res.text();
                        console.log('üìÑ Respuesta raw:', responseText.substring(0, 200));
                        
                        // Verificar si es JSON v√°lido
                        let json;
                        try {
                            json = JSON.parse(responseText);
                            console.log('‚úÖ JSON parseado exitosamente');
                        } catch (parseError) {
                            console.warn('‚ö†Ô∏è La respuesta no es JSON v√°lido, pero puede ser exitoso');
                            // Si el status es OK, asumir √©xito
                            if (res.ok || res.status === 200) {
                                setSaveStatus('saved');
                                setTimeout(() => setSaveStatus(''), 2000);
                                return;
                            }
                        }
                        
                        // Si tenemos JSON, verificar el status
                        if (json) {
                            if (json.success === false) {
                                throw new Error(json.error || 'Error al guardar');
                            }
                            console.log('‚úÖ Datos guardados exitosamente');
                        }

                        setSaveStatus('saved');
                        setTimeout(() => setSaveStatus(''), 2000);
                        savingInProgressRef.current = false; // ‚Üê Liberar bloqueo
                        
                        // ‚úÖ Si hab√≠a guardado pendiente, dispararlo ahora
                        if (guardadoPendienteRef.current) {
                            console.log('üîÑ Ejecutando guardado pendiente...');
                            setTimeout(() => guardarDatos(), 500);
                        }
                        
                    } catch (readError) {
                        // Si no podemos leer la respuesta pero el status es 200, asumimos √©xito
                        console.log('‚ö†Ô∏è No se pudo leer respuesta, pero status es:', res.status);
                        if (res.status === 200 || res.status === 0) {
                            console.log('‚úÖ Asumiendo guardado exitoso por status');
                            setSaveStatus('saved');
                            setTimeout(() => setSaveStatus(''), 2000);
                            savingInProgressRef.current = false; // ‚Üê Liberar bloqueo
                            
                            // ‚úÖ Si hab√≠a guardado pendiente, dispararlo ahora
                            if (guardadoPendienteRef.current) {
                                console.log('üîÑ Ejecutando guardado pendiente...');
                                setTimeout(() => guardarDatos(), 500);
                            }
                            return;
                        }
                        throw readError;
                    }
                    
                } catch (e) {
                    console.error('‚ùå Error guardando en servidor:', e);
                    console.error('Tipo de error:', e.name);
                    console.error('Mensaje:', e.message);
                    
                    // Si es el primer intento y hay error de red, reintentar
                    if (intentos < 1) {
                        const esErrorRed = 
                            e.name === 'TypeError' || 
                            e.message.includes('Failed to fetch') ||
                            e.message.includes('NetworkError') ||
                            e.message.includes('CORS');
                        
                        if (esErrorRed) {
                            console.log('üîÑ Error de red detectado, reintentando en 2 segundos...');
                            setSaveStatus('saving');
                            savingInProgressRef.current = false; // ‚Üê Liberar bloqueo antes de reintentar
                            setTimeout(() => {
                                guardarDatos(intentos + 1);
                            }, 2000);
                            return;
                        }
                    }
                    
                    // Si llegamos aqu√≠, mostrar error
                    savingInProgressRef.current = false; // ‚Üê Liberar bloqueo en error
                    setSaveStatus('error');
                    
                    // Log detallado para debugging
                    if (e.message.includes('CORS')) {
                        console.error('üåê Error CORS - El despliegue puede necesitar m√°s tiempo');
                        console.error('üí° Soluci√≥n: Espera 10-15 minutos y recarga la p√°gina');
                    } else if (e.message.includes('Failed to fetch')) {
                        console.error('üåê Error de red');
                        console.error('üí° Verifica tu conexi√≥n a internet');
                    } else {
                        console.error('‚ùå Error desconocido:', e);
                    }
                    
                    setTimeout(() => {
                        setSaveStatus('');
                    }, 4000);
                }
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0
                }).format(amount);
            };

            const tabs = [
                { id: 'dashboard', icon: 'üìä', label: 'Inicio' },
                { id: 'anderson', icon: 'üë§', label: 'Anderson' },
                { id: 'inventario', icon: 'üì¶', label: 'Inventario' },
                { id: 'ventas', icon: 'üí∞', label: 'Ventas' },
                { id: 'gastos', icon: 'üí∏', label: 'Gastos' },
                { id: 'cuentas', icon: 'üìã', label: 'Cuentas' }
            ];

            if (loading) {
                return (
                    <div style={{minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #6B4423 0%, #3E2723 100%)'}}>
                        <div style={{textAlign: 'center'}}>
                            <div style={{fontSize: '80px', marginBottom: '20px'}}>‚òï</div>
                            <div className="loading-spinner" style={{margin: '0 auto 20px'}}></div>
                            <p style={{color: 'white', fontSize: '18px', fontWeight: '600'}}>Bumor Caf√©</p>
                            <p style={{color: 'white', fontSize: '14px', opacity: 0.8, marginTop: '10px'}}>M√°s que un caf√©</p>
                            <p style={{color: 'white', fontSize: '12px', opacity: 0.6, marginTop: '10px'}}>Cargando datos...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{minHeight: '100vh', paddingBottom: '80px'}}>
                    {/* Indicador de guardado */}
                    {saveStatus && (
                        <div className={`save-indicator ${saveStatus}`}>
                            {saveStatus === 'saving' && (
                                <>
                                    <div className="spinner"></div>
                                    <span>Guardando...</span>
                                </>
                            )}
                            {saveStatus === 'saved' && (
                                <>
                                    <span>‚úÖ</span>
                                    <span>Guardado</span>
                                </>
                            )}
                            {saveStatus === 'error' && (
                                <>
                                    <span>‚ùå</span>
                                    <span>Error al guardar</span>
                                </>
                            )}
                        </div>
                    )}

                    <header style={{background: 'linear-gradient(to right, rgb(120, 53, 15), rgb(146, 64, 14))', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', position: 'sticky', top: 0, zIndex: 10}}>
                        <div style={{padding: '12px 16px'}}>
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                    <div style={{fontSize: '40px'}}>‚òï</div>
                                    <div>
                                        <h1 style={{fontSize: '18px', fontWeight: 'bold', color: 'white', margin: 0}}>Bumor Caf√©</h1>
                                        <p style={{fontSize: '10px', color: 'rgb(251, 191, 36)', margin: 0}}>M√°s que un caf√©</p>
                                    </div>
                                </div>
                                <button
                                    onClick={cargarDatos}
                                    style={{
                                        background: 'rgba(255,255,255,0.2)',
                                        border: 'none',
                                        borderRadius: '50%',
                                        width: '36px',
                                        height: '36px',
                                        color: 'white',
                                        fontSize: '18px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                    title="Recargar datos"
                                >
                                    üîÑ
                                </button>
                            </div>
                        </div>
                    </header>

                    <main style={{padding: '16px'}}>
                        {activeTab === 'dashboard' && <Dashboard {...{inventario, inventarioAnderson, ventas, gastos, cuentasPorCobrar, cuentasBanco, setCuentasBanco, costosProductos, inventarioEmpaques, formatCurrency}} />}
                        {activeTab === 'anderson' && <Anderson {...{inventarioAnderson, setInventarioAnderson, entregas, setEntregas, inventario, setInventario, formatCurrency}} />}
                        {activeTab === 'inventario' && <Inventario {...{inventario, setInventario, inventarioEmpaques, setInventarioEmpaques, formatCurrency}} />}
                        {activeTab === 'ventas' && <Ventas {...{ventas, setVentas, inventario, setInventario, inventarioAnderson, setInventarioAnderson, cuentasPorCobrar, setCuentasPorCobrar, cuentasBanco, setCuentasBanco, inventarioEmpaques, setInventarioEmpaques, formatCurrency}} />}
                        {activeTab === 'gastos' && <Gastos {...{gastos, setGastos, costosProductos, setCostosProductos, inventarioEmpaques, setInventarioEmpaques, cuentasBanco, setCuentasBanco, formatCurrency}} />}
                        {activeTab === 'cuentas' && <Cuentas {...{cuentasPorCobrar, setCuentasPorCobrar, cuentasBanco, setCuentasBanco, ventas, formatCurrency}} />}
                    </main>

                    <nav style={{position: 'fixed', bottom: 0, left: 0, right: 0, background: 'white', borderTop: '1px solid #e5e7eb', boxShadow: '0 -2px 10px rgba(0,0,0,0.1)', display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)'}}>
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                style={{
                                    padding: '12px 4px',
                                    background: activeTab === tab.id ? '#FEF3C7' : 'transparent',
                                    color: activeTab === tab.id ? '#92400E' : '#6B7280',
                                    border: 'none',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                }}
                            >
                                <div style={{fontSize: '20px', marginBottom: '4px'}}>{tab.icon}</div>
                                <div style={{fontSize: '10px', fontWeight: '500'}}>{tab.label}</div>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        }

        function Dashboard({ inventario, inventarioAnderson, ventas, gastos, cuentasPorCobrar, cuentasBanco, setCuentasBanco, costosProductos, inventarioEmpaques, formatCurrency }) {
            const [editingCuenta, setEditingCuenta] = useState(null);
            const [tempValores, setTempValores] = useState({});

            const totalVentas = ventas.reduce((sum, v) => sum + (v.Total || 0), 0);
            const totalGastos = gastos.reduce((sum, g) => sum + (g.Monto || 0), 0);
            const totalPorCobrar = cuentasPorCobrar.reduce((sum, c) => sum + (c.Saldo || 0), 0);
            
            // Calcular Pago Caja (ventas de contado + abonos de cr√©dito)
            const ventasContado = ventas
                .filter(v => v.TipoPago === 'contado')
                .reduce((sum, v) => sum + (v.Total || 0), 0);
            
            const abonosCredito = cuentasPorCobrar
                .reduce((sum, c) => sum + (c.Pagado || 0), 0);
            
            const totalPagoCaja = ventasContado + abonosCredito;
            
            // Calcular Flujo de Caja (Ventas - Gastos)
            const flujoCaja = totalVentas - totalGastos;
            
            const valorInventario = PRODUCTOS.reduce((sum, p) => {
                const cant = inventario[p.id] || 0;
                return sum + (cant * p.precio);
            }, 0);

            const consignacionAnderson = PRODUCTOS.reduce((sum, p) => {
                const cant = inventarioAnderson[p.id] || 0;
                return sum + (cant * p.precio);
            }, 0);

            // Calcular total de Caja y Bancos
            const totalCajaBancos = (cuentasBanco.bancolombia || 0) + 
                                   (cuentasBanco.nuBank || 0) + 
                                   (cuentasBanco.nequi || 0) + 
                                   (cuentasBanco.daviplata || 0) + 
                                   (cuentasBanco.efectivo || 0);

            const cuentasInfo = [
                { key: 'bancolombia', nombre: 'Bancolombia', icon: 'üè¶' },
                { key: 'nuBank', nombre: 'Nu Bank', icon: 'üí≥' },
                { key: 'nequi', nombre: 'Nequi', icon: 'üì±' },
                { key: 'daviplata', nombre: 'Daviplata', icon: 'üí∞' },
                { key: 'efectivo', nombre: 'Efectivo', icon: 'üíµ' }
            ];

            const handleEditarCuenta = (key) => {
                setEditingCuenta(key);
                setTempValores({ ...cuentasBanco });
            };

            const handleGuardarCuenta = () => {
                setCuentasBanco(tempValores);
                setEditingCuenta(null);
            };

            const handleCancelar = () => {
                setEditingCuenta(null);
                setTempValores({});
            };

            const handleCambiarValor = (key, valor) => {
                setTempValores(prev => ({
                    ...prev,
                    [key]: Number(valor) || 0
                }));
            };

            return (
                <div style={{maxWidth: '1200px', margin: '0 auto'}}>
                    <h2 style={{fontSize: '20px', fontWeight: 'bold', color: 'white', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span>üè†</span> Mi Inventario (Lesstherd)
                    </h2>

                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '12px', marginBottom: '24px'}}>
                        <div style={{background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)', borderRadius: '16px', padding: '16px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                                <span style={{fontSize: '20px'}}>üíµ</span>
                                <span style={{fontSize: '12px', fontWeight: '600', opacity: 0.9}}>Ventas</span>
                            </div>
                            <div style={{fontSize: '24px', fontWeight: 'bold'}}>{formatCurrency(totalVentas)}</div>
                        </div>

                        <div style={{background: 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)', borderRadius: '16px', padding: '16px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                                <span style={{fontSize: '20px'}}>üí≥</span>
                                <span style={{fontSize: '12px', fontWeight: '600', opacity: 0.9}}>Pago Caja</span>
                            </div>
                            <div style={{fontSize: '24px', fontWeight: 'bold'}}>{formatCurrency(totalPagoCaja)}</div>
                        </div>

                        <div style={{background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)', borderRadius: '16px', padding: '16px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                                <span style={{fontSize: '20px'}}>üí∏</span>
                                <span style={{fontSize: '12px', fontWeight: '600', opacity: 0.9}}>Gastos</span>
                            </div>
                            <div style={{fontSize: '24px', fontWeight: 'bold'}}>{formatCurrency(totalGastos)}</div>
                        </div>

                        <div style={{background: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)', borderRadius: '16px', padding: '16px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                                <span style={{fontSize: '20px'}}>üìä</span>
                                <span style={{fontSize: '12px', fontWeight: '600', opacity: 0.9}}>Por Cobrar</span>
                            </div>
                            <div style={{fontSize: '24px', fontWeight: 'bold'}}>{formatCurrency(totalPorCobrar)}</div>
                        </div>

                        <div style={{background: flujoCaja >= 0 ? 'linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%)' : 'linear-gradient(135deg, #DC2626 0%, #B91C1C 100%)', borderRadius: '16px', padding: '16px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                                <span style={{fontSize: '20px'}}>üìà</span>
                                <span style={{fontSize: '12px', fontWeight: '600', opacity: 0.9}}>Flujo de Caja</span>
                            </div>
                            <div style={{fontSize: '24px', fontWeight: 'bold'}}>{formatCurrency(flujoCaja)}</div>
                            <div style={{fontSize: '10px', opacity: 0.8, marginTop: '4px'}}>Ventas - Gastos</div>
                        </div>

                        <div style={{background: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)', borderRadius: '16px', padding: '16px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                                <span style={{fontSize: '20px'}}>üì¶</span>
                                <span style={{fontSize: '12px', fontWeight: '600', opacity: 0.9}}>Inventario Total</span>
                            </div>
                            <div style={{fontSize: '24px', fontWeight: 'bold'}}>{formatCurrency(valorInventario)}</div>
                        </div>
                    </div>

                    {/* Gr√°fica de Ventas por Mes */}
                    {(() => {
                        // Agrupar ventas por mes
                        const ventasPorMes = {};
                        ventas.forEach(v => {
                            // Normalizar fecha (puede venir como "2026-02-05" o "2026-02-05T00:00:00.000Z")
                            let fechaStr = v.Fecha;
                            if (typeof fechaStr === 'string' && fechaStr.includes('T')) {
                                fechaStr = fechaStr.split('T')[0]; // Quitar hora si existe
                            }
                            const fecha = new Date(fechaStr + 'T00:00:00'); // Forzar a medianoche
                            const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                            ventasPorMes[mes] = (ventasPorMes[mes] || 0) + (v.Total || 0);
                        });

                        // Obtener √∫ltimos 6 meses
                        const meses = Object.keys(ventasPorMes).sort().slice(-6);
                        if (meses.length === 0) return null;

                        const valores = meses.map(m => ventasPorMes[m]);
                        const maxValor = Math.max(...valores);

                        const nombresMeses = {
                            '01': 'Ene', '02': 'Feb', '03': 'Mar', '04': 'Abr',
                            '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Ago',
                            '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dic'
                        };

                        return (
                            <div style={{background: 'white', borderRadius: '16px', padding: '20px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', marginBottom: '24px'}}>
                                <h3 style={{fontSize: '18px', fontWeight: 'bold', color: '#1F2937', marginBottom: '16px'}}>
                                    üìä Ventas por Mes
                                </h3>
                                <div style={{display: 'flex', alignItems: 'end', gap: '12px', height: '200px'}}>
                                    {meses.map((mes, index) => {
                                        const valor = valores[index];
                                        const altura = (valor / maxValor) * 100;
                                        const mesNombre = nombresMeses[mes.split('-')[1]];
                                        
                                        return (
                                            <div key={mes} style={{flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                                                <div style={{fontSize: '11px', color: '#6B7280', marginBottom: '4px', fontWeight: '600'}}>
                                                    {formatCurrency(valor).replace('$ ', '$')}
                                                </div>
                                                <div 
                                                    style={{
                                                        width: '100%',
                                                        height: `${altura}%`,
                                                        background: 'linear-gradient(to top, #10B981, #34D399)',
                                                        borderRadius: '8px 8px 0 0',
                                                        minHeight: '20px',
                                                        transition: 'all 0.3s',
                                                        boxShadow: '0 2px 4px rgba(16, 185, 129, 0.3)'
                                                    }}
                                                />
                                                <div style={{fontSize: '12px', fontWeight: 'bold', color: '#374151', marginTop: '8px'}}>
                                                    {mesNombre}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    })()}

                    {/* Utilidades por Producto */}
                    {(() => {
                        const utilidadesPorProducto = PRODUCTOS.map(producto => {
                            // Calcular ingresos por producto (ventas)
                            const cantidadVendida = ventas.reduce((total, venta) => {
                                try {
                                    const items = typeof venta.Items === 'string' ? JSON.parse(venta.Items) : venta.Items;
                                    const itemProducto = items.find(item => parseInt(item.productoId) === producto.id);
                                    return total + (itemProducto ? parseFloat(itemProducto.cantidad) || 0 : 0);
                                } catch (e) {
                                    return total;
                                }
                            }, 0);

                            if (cantidadVendida === 0) return null;

                            const ingresos = cantidadVendida * producto.precio;
                            
                            // Calcular costos reales por unidad vendida
                            let costoTotal = 0;
                            
                            // 1. Costo de producto base
                            let costoProductoBase = 0;
                            if (producto.id === 1) { // Panela
                                costoProductoBase = (costosProductos.panela?.costo || 0) * cantidadVendida;
                            } else if (producto.id === 2) { // Caf√© Castillo
                                costoProductoBase = (costosProductos.castillo?.costo || 0) * cantidadVendida;
                            } else if (producto.id === 3) { // Caf√© Bourbon Rosado
                                costoProductoBase = (costosProductos.bourbon?.costo || 0) * cantidadVendida;
                            } else if (producto.id === 4) { // Caf√© Tabi
                                costoProductoBase = (costosProductos.tabi?.costo || 0) * cantidadVendida;
                            }
                            
                            // 2. Costo de bolsa + IVA 19%
                            let costoBolsa = 0;
                            if (producto.id === 1) { // Panela
                                costoBolsa = (inventarioEmpaques.bolsaPanela?.costoUnitario || 609.29) * 1.19 * cantidadVendida;
                            } else if (producto.id === 2) { // Castillo
                                costoBolsa = (inventarioEmpaques.bolsaCastillo?.costoUnitario || 1205.26) * 1.19 * cantidadVendida;
                            } else if (producto.id === 3) { // Bourbon
                                costoBolsa = (inventarioEmpaques.bolsaBourbon?.costoUnitario || 1205.26) * 1.19 * cantidadVendida;
                            } else if (producto.id === 4) { // Tabi
                                costoBolsa = (inventarioEmpaques.bolsaTabi?.costoUnitario || 1100) * 1.19 * cantidadVendida;
                            }
                            
                            // 3. Etiquetas/Stickers por unidad
                            const costoEtiquetas = (inventarioEmpaques.etiquetas?.costoUnitario || 210) * cantidadVendida;
                            
                            costoTotal = costoProductoBase + costoBolsa + costoEtiquetas;

                            const utilidad = ingresos - costoTotal;
                            const margen = ingresos > 0 ? ((utilidad / ingresos) * 100).toFixed(1) : 0;

                            return {
                                nombre: producto.nombre,
                                ingresos,
                                gastos: costoTotal,
                                utilidad,
                                margen,
                                cantidadVendida,
                                desglose: {
                                    costoProductoBase,
                                    costoBolsa,
                                    costoEtiquetas
                                }
                            };
                        }).filter(p => p !== null);

                        if (utilidadesPorProducto.length === 0) return null;

                        return (
                            <div style={{background: 'white', borderRadius: '16px', padding: '20px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', marginBottom: '24px'}}>
                                <h3 style={{fontSize: '18px', fontWeight: 'bold', color: '#1F2937', marginBottom: '16px'}}>
                                    üí∞ Utilidades por Producto
                                </h3>
                                <div style={{display: 'grid', gap: '12px'}}>
                                    {utilidadesPorProducto.map(p => (
                                        <div key={p.nombre} style={{background: '#F9FAFB', borderRadius: '8px', padding: '12px', border: '1px solid #E5E7EB'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px'}}>
                                                <div>
                                                    <div style={{fontSize: '14px', fontWeight: 'bold', color: '#1F2937', marginBottom: '4px'}}>
                                                        {p.nombre}
                                                    </div>
                                                    <div style={{fontSize: '11px', color: '#6B7280'}}>
                                                        Vendido: {p.cantidadVendida} unidades
                                                    </div>
                                                </div>
                                                <div style={{
                                                    padding: '4px 8px',
                                                    background: p.utilidad > 0 ? '#D1FAE5' : '#FEE2E2',
                                                    color: p.utilidad > 0 ? '#065F46' : '#991B1B',
                                                    borderRadius: '4px',
                                                    fontSize: '11px',
                                                    fontWeight: 'bold'
                                                }}>
                                                    {p.margen}% margen
                                                </div>
                                            </div>
                                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', fontSize: '12px'}}>
                                                <div>
                                                    <div style={{color: '#6B7280', fontSize: '10px'}}>Ingresos</div>
                                                    <div style={{fontWeight: 'bold', color: '#059669'}}>{formatCurrency(p.ingresos)}</div>
                                                </div>
                                                <div>
                                                    <div style={{color: '#6B7280', fontSize: '10px'}}>Gastos</div>
                                                    <div style={{fontWeight: 'bold', color: '#DC2626'}}>{formatCurrency(p.gastos)}</div>
                                                </div>
                                                <div>
                                                    <div style={{color: '#6B7280', fontSize: '10px'}}>Utilidad</div>
                                                    <div style={{fontWeight: 'bold', color: p.utilidad > 0 ? '#059669' : '#DC2626'}}>
                                                        {formatCurrency(p.utilidad)}
                                                    </div>
                                                </div>
                                            </div>
                                            {/* Desglose detallado de costos */}
                                            <div style={{marginTop: '8px', padding: '8px', background: 'white', borderRadius: '6px', border: '1px solid #E5E7EB'}}>
                                                <div style={{fontSize: '10px', fontWeight: '600', color: '#374151', marginBottom: '6px'}}>üìã Desglose de Costos:</div>
                                                <div style={{display: 'grid', gap: '3px', fontSize: '10px', color: '#6B7280'}}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                        <span>‚Ä¢ Producto + Maquila + Transporte:</span>
                                                        <span style={{fontWeight: '600', color: '#DC2626'}}>{formatCurrency(p.desglose.costoProductoBase)}</span>
                                                    </div>
                                                    <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                        <span>‚Ä¢ Bolsa + IVA 19%:</span>
                                                        <span style={{fontWeight: '600', color: '#DC2626'}}>{formatCurrency(p.desglose.costoBolsa)}</span>
                                                    </div>
                                                    <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                        <span>‚Ä¢ Etiqueta/Sticker:</span>
                                                        <span style={{fontWeight: '600', color: '#DC2626'}}>{formatCurrency(p.desglose.costoEtiquetas)}</span>
                                                    </div>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', paddingTop: '4px', borderTop: '1px solid #E5E7EB', marginTop: '4px'}}>
                                                        <span style={{fontWeight: '700'}}>TOTAL:</span>
                                                        <span style={{fontWeight: '700', color: '#DC2626'}}>{formatCurrency(p.gastos)}</span>
                                                    </div>
                                                </div>
                                                {/* ‚úÖ NUEVO: Total Valor por Unidad */}
                                                {p.cantidadVendida > 0 && (
                                                    <div style={{marginTop: '8px', padding: '8px', background: 'linear-gradient(135deg, #1E3A5F 0%, #1E40AF 100%)', borderRadius: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                        <span style={{fontSize: '11px', fontWeight: '700', color: 'white'}}>üí° Costo por unidad:</span>
                                                        <span style={{fontSize: '13px', fontWeight: 'bold', color: '#93C5FD'}}>{formatCurrency(p.gastos / p.cantidadVendida)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div style={{marginTop: '16px', padding: '12px', background: 'linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%)', borderRadius: '8px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                        <span style={{fontSize: '14px', fontWeight: 'bold', color: '#374151'}}>Utilidad Total:</span>
                                        <span style={{fontSize: '16px', fontWeight: 'bold', color: '#059669'}}>
                                            {formatCurrency(utilidadesPorProducto.reduce((sum, p) => sum + p.utilidad, 0))}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* Caja y Bancos - EDITABLE POR CUENTA */}
                    <div style={{background: 'linear-gradient(135deg, #14532D 0%, #166534 100%)', borderRadius: '16px', padding: '20px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', marginBottom: '24px'}}>
                        <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px'}}>
                            <h3 style={{fontSize: '18px', fontWeight: 'bold', margin: 0}}>üí∞ Caja y Bancos</h3>
                            <div style={{fontSize: '28px', fontWeight: 'bold'}}>
                                {formatCurrency(totalCajaBancos)}
                            </div>
                        </div>

                        <div style={{display: 'grid', gap: '12px'}}>
                            {cuentasInfo.map(cuenta => (
                                <div key={cuenta.key} style={{
                                    background: 'rgba(255,255,255,0.1)',
                                    borderRadius: '12px',
                                    padding: '12px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between'
                                }}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '8px', flex: 1}}>
                                        <span style={{fontSize: '20px'}}>{cuenta.icon}</span>
                                        <span style={{fontSize: '14px', fontWeight: '600'}}>{cuenta.nombre}</span>
                                    </div>

                                    {editingCuenta === cuenta.key ? (
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px', flex: 1}}>
                                            <input
                                                type="number"
                                                value={tempValores[cuenta.key] || 0}
                                                onChange={(e) => handleCambiarValor(cuenta.key, e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    borderRadius: '6px',
                                                    border: 'none',
                                                    fontSize: '14px',
                                                    fontWeight: 'bold'
                                                }}
                                            />
                                            <button
                                                onClick={handleGuardarCuenta}
                                                style={{
                                                    padding: '8px 12px',
                                                    background: '#10B981',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    color: 'white',
                                                    fontSize: '12px',
                                                    fontWeight: '600',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                ‚úì
                                            </button>
                                            <button
                                                onClick={handleCancelar}
                                                style={{
                                                    padding: '8px 12px',
                                                    background: '#EF4444',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    color: 'white',
                                                    fontSize: '12px',
                                                    fontWeight: '600',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    ) : (
                                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                            <span style={{fontSize: '16px', fontWeight: 'bold'}}>
                                                {formatCurrency(cuentasBanco[cuenta.key] || 0)}
                                            </span>
                                            <button
                                                onClick={() => handleEditarCuenta(cuenta.key)}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: 'rgba(255,255,255,0.2)',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    color: 'white',
                                                    fontSize: '12px',
                                                    fontWeight: '600',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                ‚úèÔ∏è
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Consignaci√≥n Anderson */}
                    <div style={{background: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)', borderRadius: '16px', padding: '20px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                            <span style={{fontSize: '20px'}}>üë§</span>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', margin: 0}}>Consignaci√≥n Anderson</h3>
                        </div>
                        <div style={{fontSize: '32px', fontWeight: 'bold', marginBottom: '8px'}}>
                            {formatCurrency(consignacionAnderson)}
                        </div>
                        <p style={{fontSize: '11px', opacity: 0.9, margin: 0}}>
                            Producto entregado que debe vender o devolver
                        </p>
                    </div>

                    {/* Alertas de Stock Bajo */}
                    {(() => {
                        const STOCK_MINIMO = 10;
                        const productosStockBajo = PRODUCTOS.filter(p => {
                            const stock = (inventario[p.id] || 0) + (inventarioAnderson[p.id] || 0);
                            return stock <= STOCK_MINIMO && stock > 0;
                        });
                        const productosSinStock = PRODUCTOS.filter(p => {
                            const stock = (inventario[p.id] || 0) + (inventarioAnderson[p.id] || 0);
                            return stock === 0;
                        });

                        if (productosStockBajo.length === 0 && productosSinStock.length === 0) return null;

                        return (
                            <div style={{background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)', borderRadius: '16px', padding: '20px', color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px'}}>
                                    <span style={{fontSize: '24px'}}>‚ö†Ô∏è</span>
                                    <h3 style={{fontSize: '16px', fontWeight: 'bold', margin: 0}}>Alertas de Inventario</h3>
                                </div>
                                
                                {productosSinStock.length > 0 && (
                                    <div style={{marginBottom: '12px'}}>
                                        <p style={{fontSize: '12px', fontWeight: '600', marginBottom: '6px', opacity: 0.9}}>
                                            üö® SIN STOCK:
                                        </p>
                                        {productosSinStock.map(p => (
                                            <div key={p.id} style={{fontSize: '13px', marginBottom: '4px', paddingLeft: '12px'}}>
                                                ‚Ä¢ {p.nombre}
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {productosStockBajo.length > 0 && (
                                    <div>
                                        <p style={{fontSize: '12px', fontWeight: '600', marginBottom: '6px', opacity: 0.9}}>
                                            ‚ö° STOCK BAJO (‚â§{STOCK_MINIMO} {PRODUCTOS[0].unidad}):
                                        </p>
                                        {productosStockBajo.map(p => {
                                            const stock = (inventario[p.id] || 0) + (inventarioAnderson[p.id] || 0);
                                            return (
                                                <div key={p.id} style={{fontSize: '13px', marginBottom: '4px', paddingLeft: '12px'}}>
                                                    ‚Ä¢ {p.nombre}: {stock} {p.unidad}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        );
                    })()}
                </div>
            );
        }

        // RESTO DE COMPONENTES (Anderson, Inventario, Ventas, Gastos, Cuentas)
        // Por brevedad, copio el resto del c√≥digo original...

        function Anderson({ inventarioAnderson, setInventarioAnderson, entregas, setEntregas, inventario, setInventario, formatCurrency }) {
            const [cantidad, setCantidad] = useState('');
            const [productoId, setProductoId] = useState('');

            const totalConsignacion = PRODUCTOS.reduce((sum, p) => {
                const cant = inventarioAnderson[p.id] || 0;
                return sum + (cant * p.precio);
            }, 0);

            const handleEntregar = () => {
                if (!productoId || !cantidad || cantidad <= 0) {
                    alert('Por favor completa todos los campos');
                    return;
                }

                const cant = parseInt(cantidad);
                const id = parseInt(productoId);

                // Verificar inventario disponible
                if ((inventario[id] || 0) < cant) {
                    alert('No hay suficiente inventario');
                    return;
                }

                // Reducir inventario principal
                setInventario(prev => ({
                    ...prev,
                    [id]: (prev[id] || 0) - cant
                }));

                // Aumentar inventario Anderson
                setInventarioAnderson(prev => ({
                    ...prev,
                    [id]: (prev[id] || 0) + cant
                }));

                // Registrar entrega
                const nuevaEntrega = {
                    ID: Date.now(),
                    Fecha: new Date().toISOString().split('T')[0],
                    ProductoID: id,
                    Cantidad: cant
                };

                setEntregas(prev => [nuevaEntrega, ...prev]);

                // Limpiar form
                setCantidad('');
                setProductoId('');
                alert('‚úÖ Entrega registrada');
            };

            return (
                <div style={{maxWidth: '600px', margin: '0 auto'}}>
                    <h2 style={{fontSize: '20px', fontWeight: 'bold', color: 'white', marginBottom: '16px'}}>
                        üë§ M√≥dulo Anderson
                    </h2>

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                            Consignaci√≥n Actual: {formatCurrency(totalConsignacion)}
                        </h3>

                        <div style={{marginBottom: '16px'}}>
                            {PRODUCTOS.map(p => (
                                <div key={p.id} style={{display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #E5E7EB'}}>
                                    <span>{p.nombre}</span>
                                    <span style={{fontWeight: 'bold'}}>
                                        {inventarioAnderson[p.id] || 0} {p.unidad}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                            Entregar Producto
                        </h3>

                        <select
                            value={productoId}
                            onChange={(e) => setProductoId(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px',
                                border: '1px solid #D1D5DB',
                                borderRadius: '8px',
                                marginBottom: '12px',
                                fontSize: '14px'
                            }}
                        >
                            <option value="">Seleccionar producto</option>
                            {PRODUCTOS.map(p => (
                                <option key={p.id} value={p.id}>
                                    {p.nombre} (Stock: {inventario[p.id] || 0} {p.unidad})
                                </option>
                            ))}
                        </select>

                        <input
                            type="number"
                            placeholder="Cantidad"
                            value={cantidad}
                            onChange={(e) => setCantidad(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px',
                                border: '1px solid #D1D5DB',
                                borderRadius: '8px',
                                marginBottom: '12px',
                                fontSize: '14px'
                            }}
                        />

                        <button
                            onClick={handleEntregar}
                            style={{
                                width: '100%',
                                padding: '12px',
                                background: 'linear-gradient(to right, #F59E0B, #D97706)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }}
                        >
                            üì¶ Entregar
                        </button>
                    </div>

                    {entregas.length > 0 && (
                        <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginTop: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                                Historial de Entregas
                            </h3>
                            {entregas.slice(0, 10).map(e => {
                                const producto = PRODUCTOS.find(p => p.id === e.ProductoID);
                                return (
                                    <div key={e.ID} style={{padding: '8px 0', borderBottom: '1px solid #E5E7EB', fontSize: '12px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                            <span>{e.Fecha}</span>
                                            <span style={{fontWeight: 'bold'}}>
                                                {producto?.nombre} - {e.Cantidad} {producto?.unidad}
                                            </span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        function Inventario({ inventario, setInventario, inventarioEmpaques, setInventarioEmpaques, formatCurrency }) {
            const [editando, setEditando] = useState(null);
            const [cantidadTemp, setCantidadTemp] = useState('');
            const [editandoEmpaque, setEditandoEmpaque] = useState(null);
            const [cantidadEmpaqueTemp, setCantidadEmpaqueTemp] = useState('');

            const handleEditar = (id) => {
                setEditando(id);
                setCantidadTemp(inventario[id] || 0);
            };

            const handleGuardar = (id) => {
                setInventario(prev => ({
                    ...prev,
                    [id]: parseInt(cantidadTemp) || 0
                }));
                setEditando(null);
            };
            
            const handleEditarEmpaque = (tipo) => {
                setEditandoEmpaque(tipo);
                setCantidadEmpaqueTemp(inventarioEmpaques[tipo]?.cantidad || 0);
            };
            
            const handleGuardarEmpaque = (tipo) => {
                const nuevaCantidad = parseInt(cantidadEmpaqueTemp) || 0;
                setInventarioEmpaques(prev => {
                    const nuevoInventario = {
                        ...prev,
                        [tipo]: {
                            cantidad: nuevaCantidad,
                            costoUnitario: prev[tipo]?.costoUnitario || 0
                        }
                    };
                    console.log('üì¶ Guardando empaque:', tipo, nuevoInventario[tipo]);
                    return nuevoInventario;
                });
                setEditandoEmpaque(null);
                
                // Feedback visual
                const tipoNombre = {
                    'etiquetas': 'Etiquetas',
                    'bolsaCastillo': 'Bolsas Caf√© Castillo',
                    'bolsaBourbon': 'Bolsas Caf√© Bourbon',
                    'bolsaPanela': 'Bolsas Panela',
                    'bolsaTabi': 'Bolsas Caf√© Tabi'
                }[tipo] || tipo;
                
                alert(`‚úÖ ${tipoNombre} actualizado: ${nuevaCantidad} unidades`);
            };

            const valorTotal = PRODUCTOS.reduce((sum, p) => {
                const cant = inventario[p.id] || 0;
                return sum + (cant * p.precio);
            }, 0);

            return (
                <div style={{maxWidth: '800px', margin: '0 auto'}}>
                    <h2 style={{fontSize: '20px', fontWeight: 'bold', color: 'white', marginBottom: '16px'}}>
                        üì¶ Inventario
                    </h2>

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', color: '#1F2937', margin: 0}}>
                                Valor Total
                            </h3>
                            <span style={{fontSize: '20px', fontWeight: 'bold', color: '#059669'}}>
                                {formatCurrency(valorTotal)}
                            </span>
                        </div>

                        <div style={{overflowX: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                <thead>
                                    <tr style={{borderBottom: '2px solid #E5E7EB'}}>
                                        <th style={{padding: '12px 8px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Producto</th>
                                        <th style={{padding: '12px 8px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Cantidad</th>
                                        <th style={{padding: '12px 8px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Precio</th>
                                        <th style={{padding: '12px 8px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Valor</th>
                                        <th style={{padding: '12px 8px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {PRODUCTOS.map(p => {
                                        const cantidad = inventario[p.id] || 0;
                                        const valor = cantidad * p.precio;
                                        return (
                                            <tr key={p.id} style={{borderBottom: '1px solid #E5E7EB'}}>
                                                <td style={{padding: '12px 8px', fontSize: '14px'}}>{p.nombre}</td>
                                                <td style={{padding: '12px 8px', textAlign: 'center'}}>
                                                    {editando === p.id ? (
                                                        <input
                                                            type="number"
                                                            value={cantidadTemp}
                                                            onChange={(e) => setCantidadTemp(e.target.value)}
                                                            style={{
                                                                width: '80px',
                                                                padding: '6px',
                                                                border: '1px solid #D1D5DB',
                                                                borderRadius: '4px',
                                                                textAlign: 'center'
                                                            }}
                                                        />
                                                    ) : (
                                                        <span style={{fontSize: '14px', fontWeight: '600'}}>
                                                            {cantidad} {p.unidad}
                                                        </span>
                                                    )}
                                                </td>
                                                <td style={{padding: '12px 8px', textAlign: 'right', fontSize: '14px'}}>
                                                    {formatCurrency(p.precio)}
                                                </td>
                                                <td style={{padding: '12px 8px', textAlign: 'right', fontSize: '14px', fontWeight: '600'}}>
                                                    {formatCurrency(valor)}
                                                </td>
                                                <td style={{padding: '12px 8px', textAlign: 'center'}}>
                                                    {editando === p.id ? (
                                                        <div style={{display: 'flex', gap: '4px', justifyContent: 'center'}}>
                                                            <button
                                                                onClick={() => handleGuardar(p.id)}
                                                                style={{
                                                                    padding: '4px 8px',
                                                                    background: '#10B981',
                                                                    color: 'white',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    fontSize: '12px',
                                                                    cursor: 'pointer'
                                                                }}
                                                            >
                                                                ‚úì
                                                            </button>
                                                            <button
                                                                onClick={() => setEditando(null)}
                                                                style={{
                                                                    padding: '4px 8px',
                                                                    background: '#EF4444',
                                                                    color: 'white',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    fontSize: '12px',
                                                                    cursor: 'pointer'
                                                                }}
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <button
                                                            onClick={() => handleEditar(p.id)}
                                                            style={{
                                                                padding: '4px 12px',
                                                                background: '#3B82F6',
                                                                color: 'white',
                                                                border: 'none',
                                                                borderRadius: '4px',
                                                                fontSize: '12px',
                                                                cursor: 'pointer'
                                                            }}
                                                        >
                                                            Editar
                                                        </button>
                                                    )}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Inventario de Empaques y Etiquetas */}
                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize: '16px', fontWeight: 'bold', color: '#1F2937', marginBottom: '16px'}}>
                            üì¶ Inventario de Empaques y Etiquetas
                        </h3>

                        <div style={{overflowX: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                <thead>
                                    <tr style={{borderBottom: '2px solid #E5E7EB'}}>
                                        <th style={{padding: '12px 8px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Tipo</th>
                                        <th style={{padding: '12px 8px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Cantidad</th>
                                        <th style={{padding: '12px 8px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Costo Unitario</th>
                                        <th style={{padding: '12px 8px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: '#6B7280'}}>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {[
                                        { id: 'etiquetas', nombre: 'Etiquetas/Stickers' },
                                        { id: 'bolsaCastillo', nombre: 'Bolsa Caf√© Castillo' },
                                        { id: 'bolsaBourbon', nombre: 'Bolsa Caf√© Bourbon Rosado' },
                                        { id: 'bolsaPanela', nombre: 'Bolsa Panela' },
                                        { id: 'bolsaTabi', nombre: 'Bolsa Caf√© Tabi' }
                                    ].map(emp => {
                                        const cantidad = inventarioEmpaques[emp.id]?.cantidad || 0;
                                        const costo = inventarioEmpaques[emp.id]?.costoUnitario || 0;
                                        return (
                                            <tr key={emp.id} style={{borderBottom: '1px solid #E5E7EB'}}>
                                                <td style={{padding: '12px 8px', fontSize: '14px'}}>{emp.nombre}</td>
                                                <td style={{padding: '12px 8px', textAlign: 'center'}}>
                                                    {editandoEmpaque === emp.id ? (
                                                        <input
                                                            type="number"
                                                            value={cantidadEmpaqueTemp}
                                                            onChange={(e) => setCantidadEmpaqueTemp(e.target.value)}
                                                            style={{
                                                                width: '80px',
                                                                padding: '6px',
                                                                border: '1px solid #D1D5DB',
                                                                borderRadius: '4px',
                                                                textAlign: 'center'
                                                            }}
                                                        />
                                                    ) : (
                                                        <span style={{fontSize: '14px', fontWeight: '600'}}>
                                                            {cantidad} und
                                                        </span>
                                                    )}
                                                </td>
                                                <td style={{padding: '12px 8px', textAlign: 'right', fontSize: '14px'}}>
                                                    {formatCurrency(costo)}
                                                </td>
                                                <td style={{padding: '12px 8px', textAlign: 'center'}}>
                                                    {editandoEmpaque === emp.id ? (
                                                        <div style={{display: 'flex', gap: '4px', justifyContent: 'center'}}>
                                                            <button
                                                                onClick={() => handleGuardarEmpaque(emp.id)}
                                                                style={{
                                                                    padding: '6px 12px',
                                                                    background: '#10B981',
                                                                    color: 'white',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    fontSize: '12px',
                                                                    cursor: 'pointer'
                                                                }}
                                                            >
                                                                ‚úì
                                                            </button>
                                                            <button
                                                                onClick={() => setEditandoEmpaque(null)}
                                                                style={{
                                                                    padding: '6px 12px',
                                                                    background: '#EF4444',
                                                                    color: 'white',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    fontSize: '12px',
                                                                    cursor: 'pointer'
                                                                }}
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <button
                                                            onClick={() => handleEditarEmpaque(emp.id)}
                                                            style={{
                                                                padding: '6px 12px',
                                                                background: '#3B82F6',
                                                                color: 'white',
                                                                border: 'none',
                                                                borderRadius: '4px',
                                                                fontSize: '12px',
                                                                cursor: 'pointer'
                                                            }}
                                                        >
                                                            ‚úèÔ∏è
                                                        </button>
                                                    )}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function Ventas({ ventas, setVentas, inventario, setInventario, inventarioAnderson, setInventarioAnderson, cuentasPorCobrar, setCuentasPorCobrar, cuentasBanco, setCuentasBanco, inventarioEmpaques, setInventarioEmpaques, formatCurrency }) {
            const [mostrarForm, setMostrarForm] = useState(false);
            const [vendedor, setVendedor] = useState('');
            const [cliente, setCliente] = useState('');
            const [items, setItems] = useState([]);
            const [tipoPago, setTipoPago] = useState('contado');
            const [abonoInicial, setAbonoInicial] = useState(''); // Para abono parcial en cr√©dito
            const [metodoPago, setMetodoPago] = useState('efectivo'); // M√©todo de pago
            const [metodoPagoAbono, setMetodoPagoAbono] = useState('efectivo'); // Para abono en cr√©dito
            const [editandoVenta, setEditandoVenta] = useState(null); // Para editar ventas

            const agregarItem = () => {
                setItems([...items, { productoId: '', cantidad: '', precio: 0 }]);
            };

            const actualizarItem = (index, campo, valor) => {
                const nuevosItems = [...items];
                nuevosItems[index][campo] = valor;
                
                if (campo === 'productoId') {
                    const producto = PRODUCTOS.find(p => p.id === parseInt(valor));
                    nuevosItems[index].precio = producto?.precio || 0;
                }
                
                setItems(nuevosItems);
            };

            const eliminarItem = (index) => {
                setItems(items.filter((_, i) => i !== index));
            };

            const calcularTotal = () => {
                return items.reduce((sum, item) => {
                    return sum + (item.cantidad * item.precio);
                }, 0);
            };

            const handleVender = () => {
                if (!vendedor || !cliente || items.length === 0) {
                    alert('Por favor completa todos los campos');
                    return;
                }

                const inventarioOrigen = vendedor === 'Anderson' ? inventarioAnderson : inventario;
                const setInventarioOrigen = vendedor === 'Anderson' ? setInventarioAnderson : setInventario;

                // Si est√° editando, primero restaurar el inventario de la venta original
                if (editandoVenta) {
                    const itemsOriginales = typeof editandoVenta.Items === 'string' ? JSON.parse(editandoVenta.Items) : editandoVenta.Items;
                    const vendedorOriginal = editandoVenta.Vendedor;
                    
                    // Restaurar inventario del vendedor original
                    if (vendedorOriginal === 'Anderson') {
                        const nuevoInvAnderson = { ...inventarioAnderson };
                        itemsOriginales.forEach(item => {
                            nuevoInvAnderson[item.productoId] = (nuevoInvAnderson[item.productoId] || 0) + parseInt(item.cantidad);
                        });
                        setInventarioAnderson(nuevoInvAnderson);
                    } else {
                        const nuevoInv = { ...inventario };
                        itemsOriginales.forEach(item => {
                            nuevoInv[item.productoId] = (nuevoInv[item.productoId] || 0) + parseInt(item.cantidad);
                        });
                        setInventario(nuevoInv);
                    }
                    
                    // Restaurar empaques
                    const empaquesRestaurados = { ...inventarioEmpaques };
                    itemsOriginales.forEach(item => {
                        const cantidad = parseInt(item.cantidad);
                        const productoId = parseInt(item.productoId);
                        
                        if (productoId === 1) {
                            empaquesRestaurados.bolsaPanela = { ...empaquesRestaurados.bolsaPanela, cantidad: (empaquesRestaurados.bolsaPanela?.cantidad || 0) + cantidad };
                        } else if (productoId === 2) {
                            empaquesRestaurados.bolsaCastillo = { ...empaquesRestaurados.bolsaCastillo, cantidad: (empaquesRestaurados.bolsaCastillo?.cantidad || 0) + cantidad };
                        } else if (productoId === 3) {
                            empaquesRestaurados.bolsaBourbon = { ...empaquesRestaurados.bolsaBourbon, cantidad: (empaquesRestaurados.bolsaBourbon?.cantidad || 0) + cantidad };
                        } else if (productoId === 4) {
                            empaquesRestaurados.bolsaTabi = { ...empaquesRestaurados.bolsaTabi, cantidad: (empaquesRestaurados.bolsaTabi?.cantidad || 0) + cantidad };
                        }
                        empaquesRestaurados.etiquetas = { ...empaquesRestaurados.etiquetas, cantidad: (empaquesRestaurados.etiquetas?.cantidad || 0) + cantidad };
                    });
                    setInventarioEmpaques(empaquesRestaurados);
                }

                // Verificar stock (con el inventario reci√©n actualizado si estamos editando)
                const inventarioParaVerificar = editandoVenta && editandoVenta.Vendedor !== vendedor 
                    ? (vendedor === 'Anderson' ? inventarioAnderson : inventario)
                    : inventarioOrigen;
                    
                for (const item of items) {
                    if ((inventarioParaVerificar[item.productoId] || 0) < item.cantidad) {
                        const producto = PRODUCTOS.find(p => p.id === parseInt(item.productoId));
                        alert(`Stock insuficiente de ${producto?.nombre}`);
                        return;
                    }
                }

                // Reducir inventario
                const nuevoInventario = { ...inventarioOrigen };
                items.forEach(item => {
                    nuevoInventario[item.productoId] = (nuevoInventario[item.productoId] || 0) - parseInt(item.cantidad);
                });
                setInventarioOrigen(nuevoInventario);
                
                // Reducir empaques (bolsas y etiquetas)
                const nuevosEmpaques = { ...inventarioEmpaques };
                items.forEach(item => {
                    const cantidad = parseInt(item.cantidad);
                    const productoId = parseInt(item.productoId);
                    
                    // Descontar bolsa seg√∫n producto
                    if (productoId === 1) { // Panela
                        nuevosEmpaques.bolsaPanela = {
                            ...nuevosEmpaques.bolsaPanela,
                            cantidad: (nuevosEmpaques.bolsaPanela?.cantidad || 0) - cantidad
                        };
                    } else if (productoId === 2) { // Caf√© Castillo
                        nuevosEmpaques.bolsaCastillo = {
                            ...nuevosEmpaques.bolsaCastillo,
                            cantidad: (nuevosEmpaques.bolsaCastillo?.cantidad || 0) - cantidad
                        };
                    } else if (productoId === 3) { // Caf√© Bourbon
                        nuevosEmpaques.bolsaBourbon = {
                            ...nuevosEmpaques.bolsaBourbon,
                            cantidad: (nuevosEmpaques.bolsaBourbon?.cantidad || 0) - cantidad
                        };
                    } else if (productoId === 4) { // Caf√© Tabi
                        nuevosEmpaques.bolsaTabi = {
                            ...nuevosEmpaques.bolsaTabi,
                            cantidad: (nuevosEmpaques.bolsaTabi?.cantidad || 0) - cantidad
                        };
                    }
                    
                    // Descontar etiquetas
                    nuevosEmpaques.etiquetas = {
                        ...nuevosEmpaques.etiquetas,
                        cantidad: (nuevosEmpaques.etiquetas?.cantidad || 0) - cantidad
                    };
                });
                setInventarioEmpaques(nuevosEmpaques);

                const total = calcularTotal();
                
                // Validar abono inicial si es a cr√©dito
                if (tipoPago === 'credito' && abonoInicial) {
                    const abono = parseFloat(abonoInicial);
                    if (abono < 0) {
                        alert('El abono no puede ser negativo');
                        return;
                    }
                    if (abono > total) {
                        alert('El abono no puede ser mayor que el total de la venta');
                        return;
                    }
                }
                
                // ‚úÖ ARREGLADO: Si est√° editando, actualizar; si no, crear nueva
                const ventaData = {
                    ID: editandoVenta ? editandoVenta.ID : Date.now(),
                    Fecha: editandoVenta ? editandoVenta.Fecha : new Date().toISOString().split('T')[0],
                    Vendedor: vendedor,
                    Cliente: cliente,
                    Items: JSON.stringify(items),
                    Total: total,
                    TipoPago: tipoPago,
                    MetodoPago: metodoPago
                };

                if (editandoVenta) {
                    // ‚úÖ ACTUALIZAR venta existente
                    setVentas(ventas.map(v => v.ID === editandoVenta.ID ? ventaData : v));
                    
                    // Actualizar cuenta bancaria si cambi√≥ el m√©todo de pago o el monto
                    if (tipoPago === 'contado') {
                        const nuevosCuentasBanco = { ...cuentasBanco };
                        // Si antes era contado, revertir el monto anterior
                        if (editandoVenta.TipoPago === 'contado' && editandoVenta.MetodoPago) {
                            nuevosCuentasBanco[editandoVenta.MetodoPago] = (nuevosCuentasBanco[editandoVenta.MetodoPago] || 0) - editandoVenta.Total;
                        }
                        // Agregar nuevo monto
                        nuevosCuentasBanco[metodoPago] = (nuevosCuentasBanco[metodoPago] || 0) + total;
                        setCuentasBanco(nuevosCuentasBanco);
                    } else if (editandoVenta.TipoPago === 'contado' && editandoVenta.MetodoPago) {
                        // Si antes era contado y ahora es cr√©dito, revertir el pago
                        const nuevosCuentasBanco = { ...cuentasBanco };
                        nuevosCuentasBanco[editandoVenta.MetodoPago] = (nuevosCuentasBanco[editandoVenta.MetodoPago] || 0) - editandoVenta.Total;
                        setCuentasBanco(nuevosCuentasBanco);
                    }
                    
                    // Actualizar cuenta por cobrar si existe
                    const cuentaExistente = cuentasPorCobrar.find(c => c.VentaID === editandoVenta.ID);
                    if (cuentaExistente) {
                        const abono = parseFloat(abonoInicial) || cuentaExistente.Pagado;
                        const saldoPendiente = total - abono;
                        
                        const cuentaActualizada = {
                            ...cuentaExistente,
                            Cliente: cliente,
                            Vendedor: vendedor,
                            Total: total,
                            Saldo: saldoPendiente,
                            Estado: saldoPendiente === 0 ? 'Pagado' : (abono > 0 ? 'Parcial' : 'Pendiente')
                        };
                        setCuentasPorCobrar(cuentasPorCobrar.map(c => c.ID === cuentaExistente.ID ? cuentaActualizada : c));
                    } else if (tipoPago === 'credito') {
                        // Si ahora es cr√©dito pero antes no ten√≠a cuenta, crearla
                        const abono = parseFloat(abonoInicial) || 0;
                        const saldoPendiente = total - abono;
                        
                        if (abono > 0) {
                            const nuevosCuentasBanco = { ...cuentasBanco };
                            nuevosCuentasBanco[metodoPagoAbono] = (nuevosCuentasBanco[metodoPagoAbono] || 0) + abono;
                            setCuentasBanco(nuevosCuentasBanco);
                        }
                        
                        const nuevaCuenta = {
                            ID: Date.now(),
                            Fecha: ventaData.Fecha,
                            Cliente: cliente,
                            Vendedor: vendedor,
                            Total: total,
                            Pagado: abono,
                            Saldo: saldoPendiente,
                            Estado: saldoPendiente === 0 ? 'Pagado' : (abono > 0 ? 'Parcial' : 'Pendiente'),
                            VentaID: ventaData.ID
                        };
                        setCuentasPorCobrar([nuevaCuenta, ...cuentasPorCobrar]);
                    }
                    
                    alert('‚úÖ Venta actualizada correctamente');
                } else {
                    // ‚úÖ CREAR nueva venta
                    setVentas([ventaData, ...ventas]);
                    
                    // Actualizar saldo bancario si es contado
                    if (tipoPago === 'contado') {
                        const nuevosCuentasBanco = { ...cuentasBanco };
                        nuevosCuentasBanco[metodoPago] = (nuevosCuentasBanco[metodoPago] || 0) + total;
                        setCuentasBanco(nuevosCuentasBanco);
                    }
                    
                    // Si es a cr√©dito, crear cuenta por cobrar
                    if (tipoPago === 'credito') {
                        const abono = parseFloat(abonoInicial) || 0;
                        const saldoPendiente = total - abono;
                        
                        // Si hay abono, sumar a la cuenta seleccionada
                        if (abono > 0) {
                            const nuevosCuentasBanco = { ...cuentasBanco };
                            nuevosCuentasBanco[metodoPagoAbono] = (nuevosCuentasBanco[metodoPagoAbono] || 0) + abono;
                            setCuentasBanco(nuevosCuentasBanco);
                        }
                        
                        const nuevaCuenta = {
                            ID: Date.now(),
                            Fecha: ventaData.Fecha,
                            Cliente: cliente,
                            Vendedor: vendedor,
                            Total: total,
                            Pagado: abono,
                            Saldo: saldoPendiente,
                            Estado: saldoPendiente === 0 ? 'Pagado' : (abono > 0 ? 'Parcial' : 'Pendiente'),
                            VentaID: ventaData.ID
                        };
                        setCuentasPorCobrar([nuevaCuenta, ...cuentasPorCobrar]);
                    }
                    
                    alert('‚úÖ Venta registrada');
                }

                // Limpiar form
                setVendedor('');
                setCliente('');
                setItems([]);
                setTipoPago('contado');
                setAbonoInicial('');
                setMetodoPago('efectivo');
                setMetodoPagoAbono('efectivo');
                setEditandoVenta(null);
                setMostrarForm(false);
                alert('‚úÖ Venta registrada');
            };
            
            const handleEditarVenta = (venta) => {
                setEditandoVenta(venta);
                setVendedor(venta.Vendedor);
                setCliente(venta.Cliente);
                const itemsVenta = typeof venta.Items === 'string' ? JSON.parse(venta.Items) : venta.Items;
                setItems(itemsVenta);
                setTipoPago(venta.TipoPago);
                setMetodoPago(venta.MetodoPago || 'efectivo');
                setMostrarForm(true);
                alert('‚ö†Ô∏è Nota: Al editar una venta, se ajustar√° el inventario autom√°ticamente');
            };
            
            const handleEliminarVenta = (ventaId) => {
                if (confirm('¬øEst√°s seguro de eliminar esta venta? Esto restaurar√° el inventario.')) {
                    const venta = ventas.find(v => v.ID === ventaId);
                    
                    if (venta) {
                        // Restaurar inventario del vendedor correspondiente
                        try {
                            const itemsVenta = typeof venta.Items === 'string' ? JSON.parse(venta.Items) : venta.Items;
                            
                            if (itemsVenta && itemsVenta.length > 0) {
                                // Restaurar inventario de productos
                                if (venta.Vendedor === 'Anderson') {
                                    const nuevoInvAnderson = { ...inventarioAnderson };
                                    itemsVenta.forEach(item => {
                                        nuevoInvAnderson[item.productoId] = (nuevoInvAnderson[item.productoId] || 0) + parseInt(item.cantidad);
                                    });
                                    setInventarioAnderson(nuevoInvAnderson);
                                } else {
                                    const nuevoInv = { ...inventario };
                                    itemsVenta.forEach(item => {
                                        nuevoInv[item.productoId] = (nuevoInv[item.productoId] || 0) + parseInt(item.cantidad);
                                    });
                                    setInventario(nuevoInv);
                                }
                                
                                // Restaurar empaques (bolsas y etiquetas)
                                const nuevosEmpaques = { ...inventarioEmpaques };
                                itemsVenta.forEach(item => {
                                    const cantidad = parseInt(item.cantidad);
                                    const productoId = parseInt(item.productoId);
                                    
                                    // Restaurar bolsa seg√∫n producto
                                    if (productoId === 1) { // Panela
                                        nuevosEmpaques.bolsaPanela = { ...nuevosEmpaques.bolsaPanela, cantidad: (nuevosEmpaques.bolsaPanela?.cantidad || 0) + cantidad };
                                    } else if (productoId === 2) { // Castillo
                                        nuevosEmpaques.bolsaCastillo = { ...nuevosEmpaques.bolsaCastillo, cantidad: (nuevosEmpaques.bolsaCastillo?.cantidad || 0) + cantidad };
                                    } else if (productoId === 3) { // Bourbon
                                        nuevosEmpaques.bolsaBourbon = { ...nuevosEmpaques.bolsaBourbon, cantidad: (nuevosEmpaques.bolsaBourbon?.cantidad || 0) + cantidad };
                                    } else if (productoId === 4) { // Tabi
                                        nuevosEmpaques.bolsaTabi = { ...nuevosEmpaques.bolsaTabi, cantidad: (nuevosEmpaques.bolsaTabi?.cantidad || 0) + cantidad };
                                    }
                                    // Restaurar etiqueta
                                    nuevosEmpaques.etiquetas = { ...nuevosEmpaques.etiquetas, cantidad: (nuevosEmpaques.etiquetas?.cantidad || 0) + cantidad };
                                });
                                setInventarioEmpaques(nuevosEmpaques);
                                
                                alert(`‚úÖ Venta eliminada. Inventario restaurado:\n${itemsVenta.map(i => `‚Ä¢ ${i.nombre}: +${i.cantidad}`).join('\n')}`);
                            } else {
                                alert('‚úÖ Venta eliminada');
                            }
                        } catch (e) {
                            console.error('Error restaurando inventario:', e);
                            alert('‚úÖ Venta eliminada (no se pudo restaurar inventario autom√°ticamente)');
                        }
                    }
                    
                    setVentas(ventas.filter(v => v.ID !== ventaId));
                    setCuentasPorCobrar(cuentasPorCobrar.filter(c => c.VentaID !== ventaId));
                }
            };

            return (
                <div style={{maxWidth: '800px', margin: '0 auto'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                        <h2 style={{fontSize: '20px', fontWeight: 'bold', color: 'white', margin: 0}}>
                            üí∞ Ventas
                        </h2>
                        <button
                            onClick={() => setMostrarForm(!mostrarForm)}
                            style={{
                                padding: '10px 20px',
                                background: 'linear-gradient(to right, #10B981, #059669)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }}
                        >
                            {mostrarForm ? '‚úï Cancelar' : '+ Nueva Venta'}
                        </button>
                    </div>

                    {/* Resumen de Productos Vendidos */}
                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                            üìä Resumen de Productos Vendidos
                        </h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '12px'}}>
                            {PRODUCTOS.map(producto => {
                                // Calcular total vendido de este producto
                                const totalVendido = ventas.reduce((total, venta) => {
                                    try {
                                        const items = typeof venta.Items === 'string' ? JSON.parse(venta.Items) : venta.Items;
                                        const itemProducto = items.find(item => parseInt(item.productoId) === producto.id);
                                        return total + (itemProducto ? parseFloat(itemProducto.cantidad) || 0 : 0);
                                    } catch (e) {
                                        return total;
                                    }
                                }, 0);

                                const valorTotal = totalVendido * producto.precio;

                                return (
                                    <div 
                                        key={producto.id}
                                        style={{
                                            background: 'linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%)',
                                            borderRadius: '8px',
                                            padding: '12px',
                                            border: '1px solid #D1D5DB'
                                        }}
                                    >
                                        <div style={{fontSize: '12px', fontWeight: '600', color: '#6B7280', marginBottom: '4px'}}>
                                            {producto.nombre}
                                        </div>
                                        <div style={{fontSize: '18px', fontWeight: 'bold', color: '#1F2937', marginBottom: '2px'}}>
                                            {totalVendido} {producto.unidad}
                                        </div>
                                        <div style={{fontSize: '12px', color: '#059669', fontWeight: '600'}}>
                                            {formatCurrency(valorTotal)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {mostrarForm && (
                        <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                                Nueva Venta
                            </h3>

                            <select
                                value={vendedor}
                                onChange={(e) => setVendedor(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #D1D5DB',
                                    borderRadius: '8px',
                                    marginBottom: '12px',
                                    fontSize: '14px'
                                }}
                            >
                                <option value="">Seleccionar vendedor</option>
                                {VENDEDORES.map(v => (
                                    <option key={v} value={v}>{v}</option>
                                ))}
                            </select>

                            <input
                                type="text"
                                placeholder="Nombre del cliente"
                                value={cliente}
                                onChange={(e) => setCliente(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #D1D5DB',
                                    borderRadius: '8px',
                                    marginBottom: '12px',
                                    fontSize: '14px'
                                }}
                            />

                            <select
                                value={tipoPago}
                                onChange={(e) => {
                                    setTipoPago(e.target.value);
                                    if (e.target.value === 'contado') {
                                        setAbonoInicial(''); // Limpiar abono si cambia a contado
                                    }
                                }}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #D1D5DB',
                                    borderRadius: '8px',
                                    marginBottom: '12px',
                                    fontSize: '14px'
                                }}
                            >
                                <option value="contado">Contado</option>
                                <option value="credito">Cr√©dito</option>
                            </select>

                            {/* M√©todo de Pago - para contado */}
                            {tipoPago === 'contado' && (
                                <div style={{marginBottom: '12px'}}>
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '4px'}}>
                                        M√©todo de Pago
                                    </label>
                                    <select
                                        value={metodoPago}
                                        onChange={(e) => setMetodoPago(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '8px',
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="efectivo">üíµ Efectivo</option>
                                        <option value="bancolombia">üè¶ Bancolombia</option>
                                        <option value="nuBank">üí≥ Nu Bank</option>
                                        <option value="nequi">üì± Nequi</option>
                                        <option value="daviplata">üí∞ Daviplata</option>
                                    </select>
                                </div>
                            )}

                            {/* Campo de abono inicial - solo visible si es a cr√©dito */}
                            {tipoPago === 'credito' && (
                                <div style={{marginBottom: '12px'}}>
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '4px'}}>
                                        Abono Inicial (Opcional)
                                    </label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        value={abonoInicial}
                                        onChange={(e) => setAbonoInicial(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            marginBottom: '8px'
                                        }}
                                    />
                                    {/* M√©todo de pago del abono */}
                                    {abonoInicial && parseFloat(abonoInicial) > 0 && (
                                        <div>
                                            <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '4px'}}>
                                                M√©todo de Pago del Abono
                                            </label>
                                            <select
                                                value={metodoPagoAbono}
                                                onChange={(e) => setMetodoPagoAbono(e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '12px',
                                                    border: '1px solid #D1D5DB',
                                                    borderRadius: '8px',
                                                    fontSize: '14px'
                                                }}
                                            >
                                                <option value="efectivo">üíµ Efectivo</option>
                                                <option value="bancolombia">üè¶ Bancolombia</option>
                                                <option value="nuBank">üí≥ Nu Bank</option>
                                                <option value="nequi">üì± Nequi</option>
                                                <option value="daviplata">üí∞ Daviplata</option>
                                            </select>
                                        </div>
                                    )}
                                    <p style={{fontSize: '11px', color: '#6B7280', marginTop: '4px', marginBottom: 0}}>
                                        Deja en 0 si no hay abono inicial
                                    </p>
                                </div>
                            )}

                            <div style={{marginBottom: '12px'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                                    <h4 style={{fontSize: '14px', fontWeight: '600', margin: 0}}>Productos</h4>
                                    <button
                                        onClick={agregarItem}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#3B82F6',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            fontSize: '12px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        + Agregar
                                    </button>
                                </div>

                                {items.map((item, index) => (
                                    <div key={index} style={{display: 'grid', gridTemplateColumns: '2fr 1fr auto', gap: '8px', marginBottom: '8px'}}>
                                        <select
                                            value={item.productoId}
                                            onChange={(e) => actualizarItem(index, 'productoId', e.target.value)}
                                            style={{
                                                padding: '8px',
                                                border: '1px solid #D1D5DB',
                                                borderRadius: '6px',
                                                fontSize: '12px'
                                            }}
                                        >
                                            <option value="">Producto</option>
                                            {PRODUCTOS.map(p => (
                                                <option key={p.id} value={p.id}>
                                                    {p.nombre} - {formatCurrency(p.precio)}
                                                </option>
                                            ))}
                                        </select>
                                        <input
                                            type="number"
                                            placeholder="Cantidad"
                                            value={item.cantidad}
                                            onChange={(e) => actualizarItem(index, 'cantidad', e.target.value)}
                                            style={{
                                                padding: '8px',
                                                border: '1px solid #D1D5DB',
                                                borderRadius: '6px',
                                                fontSize: '12px'
                                            }}
                                        />
                                        <button
                                            onClick={() => eliminarItem(index)}
                                            style={{
                                                padding: '8px',
                                                background: '#EF4444',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                fontSize: '12px',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                ))}
                            </div>

                            <div style={{borderTop: '2px solid #E5E7EB', paddingTop: '12px', marginTop: '12px'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '12px'}}>
                                    <span style={{fontSize: '16px', fontWeight: 'bold'}}>Total:</span>
                                    <span style={{fontSize: '20px', fontWeight: 'bold', color: '#059669'}}>
                                        {formatCurrency(calcularTotal())}
                                    </span>
                                </div>

                                <button
                                    onClick={handleVender}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        background: 'linear-gradient(to right, #10B981, #059669)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '16px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    üí∞ Registrar Venta
                                </button>
                            </div>
                        </div>
                    )}

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                            Historial de Ventas
                        </h3>

                        {ventas.length === 0 ? (
                            <p style={{textAlign: 'center', color: '#6B7280', padding: '20px'}}>
                                No hay ventas registradas
                            </p>
                        ) : (
                            <div style={{overflowX: 'auto'}}>
                                {ventas.map(v => (
                                    <div key={v.ID} style={{borderBottom: '1px solid #E5E7EB', padding: '12px 0'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start'}}>
                                            <div style={{flex: 1}}>
                                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                                                    <span style={{fontSize: '12px', color: '#6B7280'}}>{v.Fecha}</span>
                                                    <span style={{fontSize: '14px', fontWeight: 'bold', color: '#059669'}}>
                                                        {formatCurrency(v.Total)}
                                                    </span>
                                                </div>
                                                <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '2px'}}>
                                                    {v.Cliente}
                                                </div>
                                                <div style={{fontSize: '12px', color: '#6B7280'}}>
                                                    Vendedor: {v.Vendedor} | Pago: {v.TipoPago === 'contado' ? 'Contado' : 'Cr√©dito'}
                                                    {v.MetodoPago && ` | ${v.MetodoPago}`}
                                                </div>
                                            </div>
                                            <div style={{display: 'flex', gap: '4px', marginLeft: '8px'}}>
                                                <button
                                                    onClick={() => handleEditarVenta(v)}
                                                    style={{
                                                        padding: '6px 10px',
                                                        background: '#3B82F6',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                                <button
                                                    onClick={() => handleEliminarVenta(v.ID)}
                                                    style={{
                                                        padding: '6px 10px',
                                                        background: '#EF4444',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function Gastos({ gastos, setGastos, costosProductos, setCostosProductos, inventarioEmpaques, setInventarioEmpaques, cuentasBanco, setCuentasBanco, formatCurrency }) {
            const [mostrarForm, setMostrarForm] = useState(false);
            const [editandoGasto, setEditandoGasto] = useState(null);
            const [concepto, setConcepto] = useState('');
            const [tipo, setTipo] = useState('');
            const [monto, setMonto] = useState('');
            const [descripcion, setDescripcion] = useState('');
            const [productoRelacionado, setProductoRelacionado] = useState('');
            const [cuentaDebito, setCuentaDebito] = useState(''); // ‚úÖ NUEVO

            const CUENTAS_BANCO = [
                { id: 'efectivo',     nombre: 'Efectivo',     icon: 'üíµ' },
                { id: 'bancolombia',  nombre: 'Bancolombia',  icon: 'üè¶' },
                { id: 'nuBank',       nombre: 'Nu Bank',      icon: 'üíú' },
                { id: 'nequi',        nombre: 'Nequi',        icon: 'üì±' },
                { id: 'daviplata',    nombre: 'Daviplata',    icon: 'üí≥' },
            ];
            
            // Estados para empaques
            const [tipoEmpaque, setTipoEmpaque] = useState('');
            const [cantidadEmpaque, setCantidadEmpaque] = useState('');
            const [precioTotalEmpaque, setPrecioTotalEmpaque] = useState('');
            
            // Estados para compra productos
            const [productoCompra, setProductoCompra] = useState('');
            const [cantidadProducto, setCantidadProducto] = useState('');
            const [precioTotalProducto, setPrecioTotalProducto] = useState('');
            const [costoMaquila, setCostoMaquila] = useState('');
            const [costoTransporte, setCostoTransporte] = useState('');

            const TIPOS_GASTO = [
                'Empaques',
                'Compra Producto',
                'Etiquetas',
                'Otro'
            ];
            
            const TIPOS_EMPAQUE = [
                { id: 'bolsaCastillo', nombre: 'Bolsa Caf√© Castillo', costoBase: 1205.26 },
                { id: 'bolsaBourbon', nombre: 'Bolsa Caf√© Bourbon Rosado', costoBase: 1205.26 },
                { id: 'bolsaPanela', nombre: 'Bolsa Panela', costoBase: 609.29 },
                { id: 'bolsaTabi', nombre: 'Bolsa Caf√© Tabi', costoBase: 1100 }
            ];
            
            const PRODUCTOS_COMPRA = [
                { id: 'panela', nombre: 'Panela', unidad: 'kg', tieneMaquila: false },
                { id: 'castillo', nombre: 'Caf√© Castillo', unidad: 'lb', tieneMaquila: true },
                { id: 'bourbon', nombre: 'Caf√© Bourbon Rosado', unidad: 'lb', tieneMaquila: true },
                { id: 'tabi', nombre: 'Caf√© Tabi', unidad: 'lb', tieneMaquila: true }
            ];

            const handleAgregarGasto = () => {
                // Validaciones seg√∫n tipo
                if (!concepto || !tipo) {
                    alert('Por favor completa todos los campos obligatorios');
                    return;
                }
                
                let montoFinal = 0;
                let detallesGasto = {};
                
                // L√≥gica espec√≠fica seg√∫n tipo de gasto
                if (tipo === 'Empaques') {
                    if (!tipoEmpaque || !cantidadEmpaque || !precioTotalEmpaque) {
                        alert('Para empaques, completa: tipo, cantidad y precio total');
                        return;
                    }
                    
                    const cantidad = parseFloat(cantidadEmpaque);
                    const precioTotal = parseFloat(precioTotalEmpaque);
                    const costoUnitario = precioTotal / cantidad;
                    
                    // Actualizar inventario de empaques
                    const nuevosEmpaques = { ...inventarioEmpaques };
                    nuevosEmpaques[tipoEmpaque] = {
                        cantidad: (nuevosEmpaques[tipoEmpaque]?.cantidad || 0) + cantidad,
                        costoUnitario: costoUnitario
                    };
                    setInventarioEmpaques(nuevosEmpaques);
                    
                    montoFinal = precioTotal;
                    detallesGasto = {
                        tipoEmpaque,
                        cantidad,
                        costoUnitario
                    };
                    
                } else if (tipo === 'Compra Producto') {
                    if (!productoCompra || !cantidadProducto || !precioTotalProducto) {
                        alert('Para compra de producto, completa: producto, cantidad y precio total');
                        return;
                    }
                    
                    const cantidad = parseFloat(cantidadProducto);
                    const precioTotal = parseFloat(precioTotalProducto);
                    const maquila = parseFloat(costoMaquila) || 0;
                    const transporte = parseFloat(costoTransporte) || 0;
                    
                    const costoTotalConExtras = precioTotal + maquila + transporte;
                    const costoPorUnidad = costoTotalConExtras / cantidad;
                    
                    // Actualizar costos de productos
                    const nuevosCostos = { ...costosProductos };
                    nuevosCostos[productoCompra] = {
                        costo: costoPorUnidad,
                        costoBase: precioTotal / cantidad,
                        costoMaquila: maquila / cantidad,
                        costoTransporte: transporte / cantidad,
                        ultimaCompra: new Date().toISOString()
                    };
                    setCostosProductos(nuevosCostos);
                    
                    montoFinal = costoTotalConExtras;
                    detallesGasto = {
                        producto: productoCompra,
                        cantidad,
                        precioTotal,
                        maquila,
                        transporte,
                        costoPorUnidad
                    };
                    
                } else {
                    // Para otros tipos de gasto
                    if (!monto) {
                        alert('Por favor ingresa el monto');
                        return;
                    }
                    montoFinal = parseFloat(monto);
                }

                const gastoData = {
                    ID: editandoGasto ? editandoGasto.ID : Date.now(),
                    Fecha: editandoGasto ? editandoGasto.Fecha : new Date().toISOString().split('T')[0],
                    Concepto: concepto,
                    Tipo: tipo,
                    Monto: montoFinal,
                    Descripcion: descripcion,
                    ProductoRelacionado: productoRelacionado || null,
                    CuentaDebito: cuentaDebito || null,
                    Detalles: detallesGasto
                };

                if (editandoGasto) {
                    // Si se est√° editando y cambi√≥ la cuenta, revertir d√©bito anterior y aplicar nuevo
                    if (cuentasBanco && editandoGasto.CuentaDebito && editandoGasto.CuentaDebito !== cuentaDebito) {
                        const cuentasActualizadas = { ...cuentasBanco };
                        // Revertir d√©bito anterior
                        cuentasActualizadas[editandoGasto.CuentaDebito] = (cuentasActualizadas[editandoGasto.CuentaDebito] || 0) + editandoGasto.Monto;
                        // Aplicar nuevo d√©bito
                        if (cuentaDebito) {
                            cuentasActualizadas[cuentaDebito] = (cuentasActualizadas[cuentaDebito] || 0) - montoFinal;
                        }
                        setCuentasBanco(cuentasActualizadas);
                    }
                    setGastos(gastos.map(g => g.ID === editandoGasto.ID ? gastoData : g));
                    setEditandoGasto(null);
                    alert('‚úÖ Gasto actualizado');
                } else {
                    // Nuevo gasto: debitar cuenta si se seleccion√≥ una
                    if (cuentasBanco && cuentaDebito) {
                        const cuentasActualizadas = { ...cuentasBanco };
                        cuentasActualizadas[cuentaDebito] = (cuentasActualizadas[cuentaDebito] || 0) - montoFinal;
                        setCuentasBanco(cuentasActualizadas);
                    }
                    setGastos([gastoData, ...gastos]);
                    const nombreCuenta = CUENTAS_BANCO.find(c => c.id === cuentaDebito)?.nombre;
                    alert(cuentaDebito
                        ? `‚úÖ Gasto registrado y debitado de ${nombreCuenta}`
                        : '‚úÖ Gasto registrado (sin d√©bito de cuenta)'
                    );
                }

                // Limpiar form
                limpiarFormulario();
                setMostrarForm(false);
            };
            
            const limpiarFormulario = () => {
                setConcepto('');
                setTipo('');
                setMonto('');
                setDescripcion('');
                setProductoRelacionado('');
                setTipoEmpaque('');
                setCantidadEmpaque('');
                setPrecioTotalEmpaque('');
                setProductoCompra('');
                setCantidadProducto('');
                setPrecioTotalProducto('');
                setCostoMaquila('');
                setCostoTransporte('');
                setCuentaDebito(''); // ‚úÖ NUEVO
            };
            
            const handleEditarGasto = (gasto) => {
                setEditandoGasto(gasto);
                setConcepto(gasto.Concepto);
                setTipo(gasto.Tipo);
                setMonto(gasto.Monto?.toString() || '');
                setDescripcion(gasto.Descripcion || '');
                setProductoRelacionado(gasto.ProductoRelacionado || '');
                
                if (gasto.Detalles) {
                    if (gasto.Tipo === 'Empaques') {
                        setTipoEmpaque(gasto.Detalles.tipoEmpaque || '');
                        setCantidadEmpaque(gasto.Detalles.cantidad?.toString() || '');
                        setPrecioTotalEmpaque(gasto.Monto?.toString() || '');
                    } else if (gasto.Tipo === 'Compra Producto') {
                        setProductoCompra(gasto.Detalles.producto || '');
                        setCantidadProducto(gasto.Detalles.cantidad?.toString() || '');
                        setPrecioTotalProducto(gasto.Monto?.toString() || '');
                    }
                }
                
                setCuentaDebito(gasto.CuentaDebito || ''); // ‚úÖ NUEVO
                setMostrarForm(true);
            };
            
            const handleEliminarGasto = (id) => {
                if (confirm('¬øEst√°s seguro de eliminar este gasto?')) {
                    const gasto = gastos.find(g => g.ID === id);
                    // ‚úÖ NUEVO: Revertir d√©bito en cuenta si ten√≠a una asignada
                    if (gasto && gasto.CuentaDebito && cuentasBanco) {
                        const cuentasActualizadas = { ...cuentasBanco };
                        cuentasActualizadas[gasto.CuentaDebito] = (cuentasActualizadas[gasto.CuentaDebito] || 0) + gasto.Monto;
                        setCuentasBanco(cuentasActualizadas);
                    }
                    setGastos(gastos.filter(g => g.ID !== id));
                    alert('‚úÖ Gasto eliminado' + (gasto?.CuentaDebito ? ` y saldo restaurado en ${CUENTAS_BANCO.find(c => c.id === gasto.CuentaDebito)?.nombre}` : ''));
                }
            };

            const totalGastos = gastos.reduce((sum, g) => sum + (g.Monto || 0), 0);
            
            // Calcular gastos por categor√≠a
            const gastosPorCategoria = TIPOS_GASTO.map(tipo => ({
                tipo,
                total: gastos.filter(g => g.Tipo === tipo).reduce((sum, g) => sum + (g.Monto || 0), 0)
            })).filter(cat => cat.total > 0);

            return (
                <div style={{maxWidth: '800px', margin: '0 auto'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                        <h2 style={{fontSize: '20px', fontWeight: 'bold', color: 'white', margin: 0}}>
                            üí∏ Gastos
                        </h2>
                        <button
                            onClick={() => setMostrarForm(!mostrarForm)}
                            style={{
                                padding: '10px 20px',
                                background: 'linear-gradient(to right, #EF4444, #DC2626)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }}
                        >
                            {mostrarForm ? '‚úï Cancelar' : '+ Nuevo Gasto'}
                        </button>
                    </div>

                    {/* Resumen por categor√≠a */}
                    {gastosPorCategoria.length > 0 && (
                        <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                                üìä Gastos por Categor√≠a
                            </h3>
                            <div style={{display: 'grid', gap: '8px'}}>
                                {gastosPorCategoria.map(cat => {
                                    const porcentaje = totalGastos > 0 ? ((cat.total / totalGastos) * 100).toFixed(1) : 0;
                                    return (
                                        <div key={cat.tipo} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px', background: '#F9FAFB', borderRadius: '6px'}}>
                                            <div>
                                                <span style={{fontSize: '14px', fontWeight: '600', color: '#374151'}}>{cat.tipo}</span>
                                                <span style={{fontSize: '12px', color: '#6B7280', marginLeft: '8px'}}>({porcentaje}%)</span>
                                            </div>
                                            <span style={{fontSize: '14px', fontWeight: 'bold', color: '#DC2626'}}>
                                                {formatCurrency(cat.total)}
                                            </span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', color: '#1F2937', margin: 0}}>
                                Total Gastos
                            </h3>
                            <span style={{fontSize: '20px', fontWeight: 'bold', color: '#DC2626'}}>
                                {formatCurrency(totalGastos)}
                            </span>
                        </div>
                    </div>

                    {mostrarForm && (
                        <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                                {editandoGasto ? 'Editar Gasto' : 'Nuevo Gasto'}
                            </h3>

                            <input
                                type="text"
                                placeholder="Concepto del gasto"
                                value={concepto}
                                onChange={(e) => setConcepto(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #D1D5DB',
                                    borderRadius: '8px',
                                    marginBottom: '12px',
                                    fontSize: '14px'
                                }}
                            />

                            <select
                                value={tipo}
                                onChange={(e) => {
                                    setTipo(e.target.value);
                                    limpiarFormulario();
                                    setTipo(e.target.value);
                                }}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #D1D5DB',
                                    borderRadius: '8px',
                                    marginBottom: '12px',
                                    fontSize: '14px'
                                }}
                            >
                                <option value="">Seleccionar tipo</option>
                                {TIPOS_GASTO.map(t => (
                                    <option key={t} value={t}>{t}</option>
                                ))}
                            </select>

                            {/* Campos espec√≠ficos para EMPAQUES */}
                            {tipo === 'Empaques' && (
                                <div style={{marginBottom: '12px', padding: '12px', background: '#F3F4F6', borderRadius: '8px'}}>
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                                        Tipo de Empaque
                                    </label>
                                    <select
                                        value={tipoEmpaque}
                                        onChange={(e) => setTipoEmpaque(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '6px',
                                            marginBottom: '8px',
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="">Seleccionar empaque</option>
                                        {TIPOS_EMPAQUE.map(e => (
                                            <option key={e.id} value={e.id}>{e.nombre}</option>
                                        ))}
                                    </select>
                                    
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                                        Cantidad
                                    </label>
                                    <input
                                        type="number"
                                        placeholder="Cantidad de unidades"
                                        value={cantidadEmpaque}
                                        onChange={(e) => setCantidadEmpaque(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '6px',
                                            marginBottom: '8px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                                        Precio Total
                                    </label>
                                    <input
                                        type="number"
                                        placeholder="Precio total pagado"
                                        value={precioTotalEmpaque}
                                        onChange={(e) => setPrecioTotalEmpaque(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '6px',
                                            marginBottom: '8px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    
                                    {cantidadEmpaque && precioTotalEmpaque && (
                                        <div style={{fontSize: '12px', color: '#059669', fontWeight: '600'}}>
                                            ‚Üí Costo unitario: {formatCurrency(parseFloat(precioTotalEmpaque) / parseFloat(cantidadEmpaque))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Campos espec√≠ficos para COMPRA PRODUCTO */}
                            {tipo === 'Compra Producto' && (
                                <div style={{marginBottom: '12px', padding: '12px', background: '#F3F4F6', borderRadius: '8px'}}>
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                                        Producto
                                    </label>
                                    <select
                                        value={productoCompra}
                                        onChange={(e) => setProductoCompra(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '6px',
                                            marginBottom: '8px',
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="">Seleccionar producto</option>
                                        {PRODUCTOS_COMPRA.map(p => (
                                            <option key={p.id} value={p.id}>{p.nombre}</option>
                                        ))}
                                    </select>
                                    
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                                        Cantidad ({PRODUCTOS_COMPRA.find(p => p.id === productoCompra)?.unidad || 'unidades'})
                                    </label>
                                    <input
                                        type="number"
                                        placeholder="Cantidad"
                                        value={cantidadProducto}
                                        onChange={(e) => setCantidadProducto(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '6px',
                                            marginBottom: '8px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                                        Precio Total
                                    </label>
                                    <input
                                        type="number"
                                        placeholder="Precio total pagado"
                                        value={precioTotalProducto}
                                        onChange={(e) => setPrecioTotalProducto(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '6px',
                                            marginBottom: '8px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    
                                    {/* Maquila - solo para caf√©s */}
                                    {PRODUCTOS_COMPRA.find(p => p.id === productoCompra)?.tieneMaquila && (
                                        <>
                                            <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px', marginTop: '12px'}}>
                                                Costo Maquila (Opcional)
                                            </label>
                                            <input
                                                type="number"
                                                placeholder="Costo de maquila"
                                                value={costoMaquila}
                                                onChange={(e) => setCostoMaquila(e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '10px',
                                                    border: '1px solid #D1D5DB',
                                                    borderRadius: '6px',
                                                    marginBottom: '8px',
                                                    fontSize: '14px'
                                                }}
                                            />
                                        </>
                                    )}
                                    
                                    {/* Transporte - para todos */}
                                    <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px', marginTop: '12px'}}>
                                        Costo Transporte (Opcional)
                                    </label>
                                    <input
                                        type="number"
                                        placeholder="Costo de transporte"
                                        value={costoTransporte}
                                        onChange={(e) => setCostoTransporte(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '10px',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '6px',
                                            marginBottom: '8px',
                                            fontSize: '14px'
                                        }}
                                    />
                                    
                                    {cantidadProducto && precioTotalProducto && (
                                        <div style={{fontSize: '12px', color: '#059669', fontWeight: '600', padding: '8px', background: '#F0FDF4', borderRadius: '4px', marginTop: '8px'}}>
                                            <div>‚Üí Precio producto: {formatCurrency(parseFloat(precioTotalProducto) / parseFloat(cantidadProducto))}/{PRODUCTOS_COMPRA.find(p => p.id === productoCompra)?.unidad}</div>
                                            {costoMaquila && parseFloat(costoMaquila) > 0 && (
                                                <div>‚Üí Maquila: {formatCurrency(parseFloat(costoMaquila) / parseFloat(cantidadProducto))}/{PRODUCTOS_COMPRA.find(p => p.id === productoCompra)?.unidad}</div>
                                            )}
                                            {costoTransporte && parseFloat(costoTransporte) > 0 && (
                                                <div>‚Üí Transporte: {formatCurrency(parseFloat(costoTransporte) / parseFloat(cantidadProducto))}/{PRODUCTOS_COMPRA.find(p => p.id === productoCompra)?.unidad}</div>
                                            )}
                                            <div style={{fontWeight: 'bold', marginTop: '4px', paddingTop: '4px', borderTop: '1px solid #BBF7D0'}}>
                                                = Costo total: {formatCurrency((parseFloat(precioTotalProducto) + (parseFloat(costoMaquila) || 0) + (parseFloat(costoTransporte) || 0)) / parseFloat(cantidadProducto))}/{PRODUCTOS_COMPRA.find(p => p.id === productoCompra)?.unidad}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Campo de monto para otros tipos */}
                            {tipo && tipo !== 'Empaques' && tipo !== 'Compra Producto' && (
                                <input
                                    type="number"
                                    placeholder="Monto"
                                    value={monto}
                                    onChange={(e) => setMonto(e.target.value)}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        border: '1px solid #D1D5DB',
                                        borderRadius: '8px',
                                        marginBottom: '12px',
                                        fontSize: '14px'
                                    }}
                                />
                            )}

                            <textarea
                                placeholder="Descripci√≥n (opcional)"
                                value={descripcion}
                                onChange={(e) => setDescripcion(e.target.value)}
                                rows={3}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #D1D5DB',
                                    borderRadius: '8px',
                                    marginBottom: '12px',
                                    fontSize: '14px',
                                    resize: 'vertical'
                                }}
                            />

                            {/* ‚úÖ NUEVO: Selector de cuenta para d√©bito */}
                            <div style={{marginBottom: '12px'}}>
                                <label style={{display: 'block', fontSize: '12px', fontWeight: '600', color: '#374151', marginBottom: '8px'}}>
                                    üí≥ D√©bitar de cuenta (opcional)
                                </label>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '6px'}}>
                                    {CUENTAS_BANCO.map(cuenta => (
                                        <button
                                            key={cuenta.id}
                                            type="button"
                                            onClick={() => setCuentaDebito(cuentaDebito === cuenta.id ? '' : cuenta.id)}
                                            style={{
                                                padding: '8px 6px',
                                                border: cuentaDebito === cuenta.id ? '2px solid #EF4444' : '1px solid #D1D5DB',
                                                borderRadius: '8px',
                                                background: cuentaDebito === cuenta.id ? '#FEE2E2' : 'white',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                fontWeight: cuentaDebito === cuenta.id ? '700' : '500',
                                                color: cuentaDebito === cuenta.id ? '#B91C1C' : '#374151',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                alignItems: 'center',
                                                gap: '2px'
                                            }}
                                        >
                                            <span style={{fontSize: '16px'}}>{cuenta.icon}</span>
                                            <span>{cuenta.nombre}</span>
                                            {cuentasBanco && (
                                                <span style={{fontSize: '10px', color: '#6B7280'}}>
                                                    {formatCurrency(cuentasBanco[cuenta.id] || 0)}
                                                </span>
                                            )}
                                        </button>
                                    ))}
                                </div>
                                {cuentaDebito && (
                                    <div style={{marginTop: '6px', padding: '6px 10px', background: '#FEE2E2', borderRadius: '6px', fontSize: '12px', color: '#B91C1C', fontWeight: '600'}}>
                                        ‚ö†Ô∏è Se debitar√° de {CUENTAS_BANCO.find(c => c.id === cuentaDebito)?.nombre}
                                    </div>
                                )}
                            </div>

                            <div style={{display: 'flex', gap: '8px'}}>
                                <button
                                    onClick={handleAgregarGasto}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        background: 'linear-gradient(to right, #EF4444, #DC2626)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '16px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    {editandoGasto ? '‚úì Actualizar' : 'üí∏ Registrar Gasto'}
                                </button>
                                {editandoGasto && (
                                    <button
                                        onClick={() => {
                                            setEditandoGasto(null);
                                            limpiarFormulario();
                                            setMostrarForm(false);
                                        }}
                                        style={{
                                            padding: '12px 20px',
                                            background: '#6B7280',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontSize: '16px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Cancelar
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                            Historial de Gastos
                        </h3>

                        {gastos.length === 0 ? (
                            <p style={{textAlign: 'center', color: '#6B7280', padding: '20px'}}>
                                No hay gastos registrados
                            </p>
                        ) : (
                            <div style={{overflowX: 'auto'}}>
                                {gastos.map(g => (
                                    <div key={g.ID} style={{borderBottom: '1px solid #E5E7EB', padding: '12px 0'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '4px'}}>
                                            <div style={{flex: 1}}>
                                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                                                    <span style={{fontSize: '12px', color: '#6B7280'}}>{g.Fecha}</span>
                                                    <span style={{fontSize: '14px', fontWeight: 'bold', color: '#DC2626'}}>
                                                        {formatCurrency(g.Monto)}
                                                    </span>
                                                </div>
                                                <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '2px'}}>
                                                    {g.Concepto}
                                                </div>
                                                <div style={{fontSize: '12px', color: '#6B7280'}}>
                                                    Tipo: {g.Tipo}
                                                    {g.Descripcion && ` | ${g.Descripcion}`}
                                                </div>
                                                {/* ‚úÖ NUEVO: Mostrar cuenta debitada */}
                                                {g.CuentaDebito && (
                                                    <div style={{fontSize: '11px', marginTop: '3px', display: 'inline-flex', alignItems: 'center', gap: '4px', padding: '2px 7px', background: '#FEE2E2', borderRadius: '10px', color: '#B91C1C', fontWeight: '600'}}>
                                                        {CUENTAS_BANCO.find(c => c.id === g.CuentaDebito)?.icon} {CUENTAS_BANCO.find(c => c.id === g.CuentaDebito)?.nombre}
                                                    </div>
                                                )}
                                                {g.Detalles && (
                                                    <div style={{fontSize: '11px', color: '#059669', marginTop: '4px'}}>
                                                        {g.Tipo === 'Empaques' && g.Detalles.cantidad && (
                                                            `üì¶ ${g.Detalles.cantidad} und @ ${formatCurrency(g.Detalles.costoUnitario)}`
                                                        )}
                                                        {g.Tipo === 'Compra Producto' && g.Detalles.cantidad && (
                                                            `üåæ ${g.Detalles.cantidad} ${PRODUCTOS_COMPRA.find(p => p.id === g.Detalles.producto)?.unidad} @ ${formatCurrency(g.Detalles.costoPorUnidad)}`
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div style={{display: 'flex', gap: '4px', marginLeft: '8px'}}>
                                                <button
                                                    onClick={() => handleEditarGasto(g)}
                                                    style={{
                                                        padding: '6px 10px',
                                                        background: '#3B82F6',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                                <button
                                                    onClick={() => handleEliminarGasto(g.ID)}
                                                    style={{
                                                        padding: '6px 10px',
                                                        background: '#EF4444',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function Cuentas({ cuentasPorCobrar, setCuentasPorCobrar, cuentasBanco, setCuentasBanco, ventas, formatCurrency }) {
            const [mostrarPago, setMostrarPago] = useState(null);
            const [montoPago, setMontoPago] = useState('');
            const [metodoPagoAbono, setMetodoPagoAbono] = useState('efectivo');

            const handleRegistrarPago = (cuentaId) => {
                const cuenta = cuentasPorCobrar.find(c => c.ID === cuentaId);
                const pago = parseFloat(montoPago);

                if (!pago || pago <= 0 || pago > cuenta.Saldo) {
                    alert('Monto de pago inv√°lido');
                    return;
                }

                const nuevasCuentas = cuentasPorCobrar.map(c => {
                    if (c.ID === cuentaId) {
                        const nuevoPagado = c.Pagado + pago;
                        const nuevoSaldo = c.Total - nuevoPagado;
                        return {
                            ...c,
                            Pagado: nuevoPagado,
                            Saldo: nuevoSaldo,
                            Estado: nuevoSaldo === 0 ? 'Pagado' : 'Parcial'
                        };
                    }
                    return c;
                });

                setCuentasPorCobrar(nuevasCuentas);
                
                // Actualizar saldo bancario
                const nuevosCuentasBanco = { ...cuentasBanco };
                nuevosCuentasBanco[metodoPagoAbono] = (nuevosCuentasBanco[metodoPagoAbono] || 0) + pago;
                setCuentasBanco(nuevosCuentasBanco);
                
                setMostrarPago(null);
                setMontoPago('');
                setMetodoPagoAbono('efectivo');
                alert('‚úÖ Pago registrado');
            };

            const totalPendiente = cuentasPorCobrar
                .filter(c => c.Estado !== 'Pagado')
                .reduce((sum, c) => sum + c.Saldo, 0);

            // ‚úÖ NUEVO: Totales por vendedor (con fallback a ventas para cuentas antiguas)
            const totalesPorVendedor = cuentasPorCobrar
                .filter(c => c.Estado !== 'Pagado')
                .reduce((acc, c) => {
                    // Buscar vendedor: primero en la cuenta, luego en la venta relacionada
                    let vendedor = c.Vendedor;
                    if (!vendedor && c.VentaID && ventas) {
                        const ventaRelacionada = ventas.find(v => v.ID === c.VentaID);
                        vendedor = ventaRelacionada?.Vendedor;
                    }
                    vendedor = vendedor || 'Sin asignar';
                    acc[vendedor] = (acc[vendedor] || 0) + c.Saldo;
                    return acc;
                }, {});

            const cuentasActivas = cuentasPorCobrar.filter(c => c.Estado !== 'Pagado');
            const cuentasPagadas = cuentasPorCobrar.filter(c => c.Estado === 'Pagado');
            
            // Calcular deudas vencidas (m√°s de 15 d√≠as)
            const cuentasVencidas = cuentasActivas.filter(c => {
                const fechaCuenta = new Date(c.Fecha);
                const hoy = new Date();
                const diasTranscurridos = Math.floor((hoy - fechaCuenta) / (1000 * 60 * 60 * 24));
                return diasTranscurridos > 15;
            });

            const generarMensajeWhatsApp = (cuenta) => {
                const fechaCuenta = new Date(cuenta.Fecha);
                const hoy = new Date();
                const diasTranscurridos = Math.floor((hoy - fechaCuenta) / (1000 * 60 * 60 * 24));
                
                const mensaje = `Hola ${cuenta.Cliente}! üëã

Te recordamos que tienes un saldo pendiente con Bumor Caf√©:

üí∞ Total: ${formatCurrency(cuenta.Total)}
‚úÖ Pagado: ${formatCurrency(cuenta.Pagado)}
‚ö†Ô∏è Saldo: ${formatCurrency(cuenta.Saldo)}

üìÖ Hace ${diasTranscurridos} d√≠as (desde ${cuenta.Fecha})

Agradecemos tu pronto pago. ¬°Gracias por tu confianza! ‚òï`;

                navigator.clipboard.writeText(mensaje);
                alert('üìã Mensaje copiado! Ahora p√©galo en WhatsApp');
            };

            return (
                <div style={{maxWidth: '800px', margin: '0 auto'}}>
                    <h2 style={{fontSize: '20px', fontWeight: 'bold', color: 'white', marginBottom: '16px'}}>
                        üìã Cuentas por Cobrar
                    </h2>

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: Object.keys(totalesPorVendedor).length > 0 ? '12px' : '0'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', color: '#1F2937', margin: 0}}>
                                Total Pendiente
                            </h3>
                            <span style={{fontSize: '20px', fontWeight: 'bold', color: '#F59E0B'}}>
                                {formatCurrency(totalPendiente)}
                            </span>
                        </div>
                        {/* ‚úÖ NUEVO: Por Vendedor */}
                        {Object.keys(totalesPorVendedor).length > 0 && (
                            <div style={{borderTop: '1px solid #E5E7EB', paddingTop: '10px', display: 'grid', gap: '6px'}}>
                                <div style={{fontSize: '11px', fontWeight: '600', color: '#6B7280', marginBottom: '2px'}}>POR VENDEDOR:</div>
                                {Object.entries(totalesPorVendedor).map(([vendedor, saldo]) => (
                                    <div key={vendedor} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 10px', background: '#FEF3C7', borderRadius: '6px', border: '1px solid #FCD34D'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                                            <span style={{fontSize: '14px'}}>üë§</span>
                                            <span style={{fontSize: '13px', fontWeight: '600', color: '#92400E'}}>{vendedor}</span>
                                        </div>
                                        <span style={{fontSize: '14px', fontWeight: 'bold', color: '#B45309'}}>{formatCurrency(saldo)}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Alertas de Deudas Vencidas (m√°s de 15 d√≠as) */}
                    {cuentasVencidas.length > 0 && (
                        <div style={{background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', color: 'white'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px'}}>
                                <span style={{fontSize: '24px'}}>‚è∞</span>
                                <h3 style={{fontSize: '16px', fontWeight: 'bold', margin: 0}}>
                                    Deudas Vencidas (+15 d√≠as) - {cuentasVencidas.length}
                                </h3>
                            </div>
                            
                            {cuentasVencidas.map(c => {
                                const fechaCuenta = new Date(c.Fecha);
                                const hoy = new Date();
                                const diasTranscurridos = Math.floor((hoy - fechaCuenta) / (1000 * 60 * 60 * 24));
                                
                                return (
                                    <div key={c.ID} style={{background: 'rgba(255,255,255,0.15)', borderRadius: '8px', padding: '12px', marginBottom: '8px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px'}}>
                                            <div>
                                                <div style={{fontSize: '14px', fontWeight: 'bold', marginBottom: '4px'}}>
                                                    {c.Cliente}
                                                </div>
                                                <div style={{fontSize: '12px', opacity: 0.9}}>
                                                    ‚è±Ô∏è {diasTranscurridos} d√≠as vencidos
                                                </div>
                                                <div style={{fontSize: '13px', fontWeight: 'bold', marginTop: '4px'}}>
                                                    Debe: {formatCurrency(c.Saldo)}
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => generarMensajeWhatsApp(c)}
                                                style={{
                                                    padding: '8px 12px',
                                                    background: '#25D366',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    fontSize: '12px',
                                                    fontWeight: 'bold',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '4px'
                                                }}
                                            >
                                                üì± Copiar Mensaje
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    <div style={{background: 'white', borderRadius: '12px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                            Cuentas Activas ({cuentasActivas.length})
                        </h3>

                        {cuentasActivas.length === 0 ? (
                            <p style={{textAlign: 'center', color: '#6B7280', padding: '20px'}}>
                                No hay cuentas pendientes
                            </p>
                        ) : (
                            cuentasActivas.map(c => (
                                <div key={c.ID} style={{borderBottom: '1px solid #E5E7EB', padding: '12px 0'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}>
                                        <div>
                                            <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '2px'}}>
                                                {c.Cliente}
                                            </div>
                                            <div style={{fontSize: '12px', color: '#6B7280'}}>
                                                Fecha: {c.Fecha}
                                            </div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{fontSize: '16px', fontWeight: 'bold', color: '#F59E0B'}}>
                                                {formatCurrency(c.Saldo)}
                                            </div>
                                            <div style={{fontSize: '12px', color: '#6B7280'}}>
                                                de {formatCurrency(c.Total)}
                                            </div>
                                        </div>
                                    </div>

                                    {mostrarPago === c.ID ? (
                                        <div style={{marginTop: '12px'}}>
                                            <input
                                                type="number"
                                                placeholder="Monto del pago"
                                                value={montoPago}
                                                onChange={(e) => setMontoPago(e.target.value)}
                                                max={c.Saldo}
                                                style={{
                                                    width: '100%',
                                                    padding: '8px',
                                                    border: '1px solid #D1D5DB',
                                                    borderRadius: '6px',
                                                    marginBottom: '8px',
                                                    fontSize: '14px'
                                                }}
                                            />
                                            <select
                                                value={metodoPagoAbono}
                                                onChange={(e) => setMetodoPagoAbono(e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '8px',
                                                    border: '1px solid #D1D5DB',
                                                    borderRadius: '6px',
                                                    marginBottom: '8px',
                                                    fontSize: '14px'
                                                }}
                                            >
                                                <option value="efectivo">üíµ Efectivo</option>
                                                <option value="bancolombia">üè¶ Bancolombia</option>
                                                <option value="nuBank">üí≥ Nu Bank</option>
                                                <option value="nequi">üì± Nequi</option>
                                                <option value="daviplata">üí∞ Daviplata</option>
                                            </select>
                                            <div style={{display: 'flex', gap: '8px'}}>
                                                <button
                                                    onClick={() => handleRegistrarPago(c.ID)}
                                                    style={{
                                                        flex: 1,
                                                        padding: '8px',
                                                        background: '#10B981',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        fontSize: '12px',
                                                        fontWeight: '600',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    ‚úì Confirmar
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setMostrarPago(null);
                                                        setMontoPago('');
                                                        setMetodoPagoAbono('efectivo');
                                                    }}
                                                    style={{
                                                        flex: 1,
                                                        padding: '8px',
                                                        background: '#EF4444',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        fontSize: '12px',
                                                        fontWeight: '600',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    ‚úï Cancelar
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <button
                                            onClick={() => {
                                                setMostrarPago(c.ID);
                                                setMontoPago(c.Saldo);
                                            }}
                                            style={{
                                                width: '100%',
                                                padding: '8px',
                                                background: '#3B82F6',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                marginTop: '8px'
                                            }}
                                        >
                                            üí∞ Registrar Pago
                                        </button>
                                    )}
                                </div>
                            ))
                        )}
                    </div>

                    {cuentasPagadas.length > 0 && (
                        <div style={{background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '12px', color: '#1F2937'}}>
                                Cuentas Pagadas ({cuentasPagadas.length})
                            </h3>

                            {cuentasPagadas.map(c => (
                                <div key={c.ID} style={{borderBottom: '1px solid #E5E7EB', padding: '12px 0'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                        <div>
                                            <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '2px'}}>
                                                {c.Cliente}
                                            </div>
                                            <div style={{fontSize: '12px', color: '#6B7280'}}>
                                                Fecha: {c.Fecha}
                                            </div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{fontSize: '14px', fontWeight: 'bold', color: '#10B981'}}>
                                                {formatCurrency(c.Total)}
                                            </div>
                                            <div style={{fontSize: '12px', color: '#10B981'}}>
                                                ‚úì Pagado
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
